/**
 * UniversalTracker - Comprehensive Event Tracking Library
 * A lightweight, generic analytics tracker for any website
 * 
 * @version 2.0.0
 * @license MIT
 */
!function(t){"use strict";class e{constructor(e={}){return this.config={apiEndpoint:e.apiEndpoint||null,projectId:e.projectId||"default",debug:e.debug||!1,trackPageViews:!1!==e.trackPageViews,trackClicks:!1!==e.trackClicks,trackScrolls:!1!==e.trackScrolls,trackForms:!1!==e.trackForms,trackErrors:!1!==e.trackErrors,trackPerformance:!1!==e.trackPerformance,trackUserTiming:!1!==e.trackUserTiming,batchSize:e.batchSize||20,batchInterval:e.batchInterval||15e3,sampleRate:e.sampleRate||1,beforeSend:e.beforeSend||null,onError:e.onError||null,useLocalStorage:!1!==e.useLocalStorage,storageDuration:e.storageDuration||2592e6,anonymizeIP:e.anonymizeIP||!1,respectDoNotTrack:e.respectDoNotTrack||!1,enablePopovers:!1!==e.enablePopovers,popoverApiKey:e.popoverApiKey||null,popoverEnablePeriodicChecks:!1!==e.popoverEnablePeriodicChecks,popoverCheckInterval:e.popoverCheckInterval||3e4,popoverMinDelay:e.popoverMinDelay||1e4,popoverMaxPerSession:e.popoverMaxPerSession||3,popoverUseFastEndpoint:!1!==e.popoverUseFastEndpoint,immediatePopoverEvents:e.immediatePopoverEvents||["exit_intent","rage_click","form_abandon","form_start","scroll_depth"]},this.config.respectDoNotTrack&&"1"===navigator.doNotTrack?(this.log("Tracking disabled: Do Not Track is enabled"),void(this.enabled=!1)):Math.random()>this.config.sampleRate?(this.log("User not sampled for tracking"),void(this.enabled=!1)):(this.enabled=!0,this.sessionId=this.getOrCreateSession(),this.visitorId=this.getOrCreateVisitor(),this.userId=e.userId||null,this.eventQueue=[],this.batchTimer=null,this.startTime=Date.now(),this.lastActivityTime=Date.now(),this.pageLoadTime=Date.now(),this.state={currentUrl:t.location.href,currentPath:t.location.pathname,pageTitle:document.title,referrer:document.referrer,userAgent:navigator.userAgent,language:navigator.language,platform:navigator.platform,screenWidth:t.screen.width,screenHeight:t.screen.height,viewportWidth:t.innerWidth,viewportHeight:t.innerHeight,timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,pageViews:0,totalClicks:0,totalScrolls:0,maxScrollDepth:0,currentScrollDepth:0,timeOnPage:0,activeTime:0,idleTime:0,formSubmissions:0,formStarts:0,formAbandons:0,linkClicks:0,buttonClicks:0,downloadClicks:0,outboundClicks:0,videoPlays:0,mediaInteractions:0,searchQueries:[],errors:0,pageLoadDuration:0,isReturningVisitor:!1,exitIntentDetected:!1,rageClickDetected:!1},this.handlers={},this.throttledEvents=new Set,this.rageClickData={count:0,lastTime:0,element:null},this.popoverState={shown:new Set,count:0,lastCheckTime:0,currentPopover:null,checkTimer:null},void this.log("UniversalTracker initialized",{sessionId:this.sessionId,visitorId:this.visitorId,config:this.config}))}init(){return this.enabled?(this.log("Starting tracking..."),this.state.isReturningVisitor=this.checkReturningVisitor(),this.config.trackPageViews&&this.trackPageView(),this.config.trackPerformance&&this.trackPerformance(),this.setupListeners(),this.startBatchTimer(),this.trackVisibility(),this.setupExitTracking(),this.startActivityMonitoring(),this.config.trackErrors&&this.setupErrorTracking(),this.config.enablePopovers&&this.config.popoverApiKey&&this.startPopoverSystem(),this.setupChatListeners(),this.log("Tracking started successfully"),this):this}setupChatListeners(){const t=()=>{const e=document.getElementById("tharwah-chat-button"),n=document.getElementById("tharwah-chat-window");if(e&&n){new MutationObserver(t=>{t.forEach(t=>{if("attributes"===t.type&&("style"===t.attributeName||"class"===t.attributeName)){(n.classList.contains("active")||"none"!==n.style.display)&&(this.hidePopover(),this.log("Chat opened, hiding popover"))}})}).observe(n,{attributes:!0,attributeFilter:["style","class"]}),this.log("Chat listeners setup complete")}else setTimeout(t,500)};setTimeout(t,1e3)}destroy(){this.log("Destroying tracker..."),this.removeListeners(),this.stopBatchTimer(),this.flush(),this.enabled=!1}getOrCreateSession(){const t="_ut_session",e=this.getStorage(t);if(e&&Date.now()-e.timestamp<18e5)return e.id;const n=this.generateId("sess");return this.setStorage(t,{id:n,timestamp:Date.now()}),n}getOrCreateVisitor(){const t="_ut_visitor",e=this.getStorage(t);if(e)return e.id;const n=this.generateId("vis");return this.setStorage(t,{id:n,firstSeen:Date.now(),visits:1}),n}checkReturningVisitor(){const t=this.getStorage("_ut_visitor");return!!t&&(t.visits=(t.visits||0)+1,t.lastSeen=Date.now(),this.setStorage("_ut_visitor",t),t.visits>1)}generateId(t="id"){return`${t}_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}getStorage(t){if(!this.config.useLocalStorage)return null;try{const e=localStorage.getItem(`ut_${this.config.projectId}_${t}`);return e?JSON.parse(e):null}catch(t){return null}}setStorage(t,e){if(this.config.useLocalStorage)try{localStorage.setItem(`ut_${this.config.projectId}_${t}`,JSON.stringify(e))}catch(t){this.log("Storage error:",t)}}clearStorage(t){if(this.config.useLocalStorage)try{localStorage.removeItem(`ut_${this.config.projectId}_${t}`)}catch(t){this.log("Storage error:",t)}}setupListeners(){this.config.trackScrolls&&(this.handlers.scroll=this.throttle(()=>this.handleScroll(),300),t.addEventListener("scroll",this.handlers.scroll,{passive:!0})),this.config.trackClicks&&(this.handlers.click=t=>this.handleClick(t),document.addEventListener("click",this.handlers.click,!0)),this.config.trackForms&&(this.handlers.submit=t=>this.handleFormSubmit(t),this.handlers.focus=t=>this.handleFormFocus(t),this.handlers.blur=t=>this.handleFormBlur(t),document.addEventListener("submit",this.handlers.submit,!0),document.addEventListener("focus",this.handlers.focus,!0),document.addEventListener("blur",this.handlers.blur,!0)),this.handlers.visibility=()=>this.handleVisibilityChange(),document.addEventListener("visibilitychange",this.handlers.visibility),this.handlers.resize=this.throttle(()=>this.handleResize(),1e3),t.addEventListener("resize",this.handlers.resize),this.handlers.mouseout=t=>this.detectExitIntent(t),document.addEventListener("mouseout",this.handlers.mouseout),this.handlers.popstate=()=>this.handleNavigation(),t.addEventListener("popstate",this.handlers.popstate)}removeListeners(){this.handlers.scroll&&t.removeEventListener("scroll",this.handlers.scroll),this.handlers.click&&document.removeEventListener("click",this.handlers.click,!0),this.handlers.submit&&document.removeEventListener("submit",this.handlers.submit,!0),this.handlers.focus&&document.removeEventListener("focus",this.handlers.focus,!0),this.handlers.blur&&document.removeEventListener("blur",this.handlers.blur,!0),this.handlers.visibility&&document.removeEventListener("visibilitychange",this.handlers.visibility),this.handlers.resize&&t.removeEventListener("resize",this.handlers.resize),this.handlers.mouseout&&document.removeEventListener("mouseout",this.handlers.mouseout),this.handlers.popstate&&t.removeEventListener("popstate",this.handlers.popstate)}trackPageView(e={}){this.state.pageViews++,this.track("page_view",{url:t.location.href,path:t.location.pathname,title:document.title,referrer:document.referrer,hash:t.location.hash,queryString:t.location.search,...e})}handleScroll(){const e=t.pageYOffset||document.documentElement.scrollTop,n=document.documentElement.scrollHeight-t.innerHeight,o=n>0?Math.round(e/n*100):0;this.state.currentScrollDepth=o,this.state.maxScrollDepth=Math.max(this.state.maxScrollDepth,o),this.state.totalScrolls++;[25,50,75,90,100].forEach(t=>{const e=`scroll_${t}`;o>=t&&!this.throttledEvents.has(e)&&(this.throttledEvents.add(e),this.track("scroll_depth",{depth:t}))}),this.updateActivity()}handleClick(t){this.state.totalClicks++;const e=t.target.closest('a, button, [role="button"], [onclick]')||t.target,n=this.getElementData(e);this.detectRageClick(t,e),"A"===e.tagName?(this.state.linkClicks++,this.trackLinkClick(e,n)):"BUTTON"===e.tagName||"button"===e.getAttribute("role")?(this.state.buttonClicks++,this.track("button_click",n)):this.track("click",n),this.updateActivity()}trackLinkClick(e,n){const o=e.href||"",i=e.hasAttribute("download")||/\.(pdf|zip|doc|docx|xls|xlsx|ppt|pptx|txt|csv)$/i.test(o),r=o&&e.hostname!==t.location.hostname&&""!==e.hostname;i?(this.state.downloadClicks++,this.track("download",{...n,file:o})):r?(this.state.outboundClicks++,this.track("outbound_link",{...n,destination:o})):this.track("link_click",n)}detectRageClick(t,e){const n=Date.now();this.rageClickData.element===e&&n-this.rageClickData.lastTime<500?(this.rageClickData.count++,this.rageClickData.count>=3&&!this.state.rageClickDetected&&(this.state.rageClickDetected=!0,this.track("rage_click",{element:this.getElementData(e),clickCount:this.rageClickData.count}))):(this.rageClickData.count=1,this.rageClickData.element=e),this.rageClickData.lastTime=n}handleFormSubmit(t){const e=t.target;this.state.formSubmissions++,this.throttledEvents.add(`form_submit_${e.id||"default"}`),this.track("form_submit",{formId:e.id,formName:e.name,formAction:e.action,formMethod:e.method,fieldCount:e.elements.length})}handleFormFocus(t){const e=t.target;if(this.isFormField(e)){const t=this.getFieldKey(e);this.throttledEvents.has(`form_start_${t}`)||(this.throttledEvents.add(`form_start_${t}`),this.state.formStarts++,this.track("form_start",{formId:e.form?.id,fieldName:e.name||e.id,fieldType:e.type}))}}handleFormBlur(t){const e=t.target;this.isFormField(e)&&(this.track("form_field_complete",{formId:e.form?.id,fieldName:e.name||e.id,fieldType:e.type,filled:!!e.value}),e.form&&!this.throttledEvents.has(`form_abandon_${e.form.id||"default"}`)&&setTimeout(()=>{this.throttledEvents.has(`form_submit_${e.form.id||"default"}`)||(this.throttledEvents.add(`form_abandon_${e.form.id||"default"}`),this.track("form_abandon",{formId:e.form.id,formName:e.form.name,formAction:e.form.action,fieldsFilled:Array.from(e.form.elements).filter(t=>this.isFormField(t)&&t.value).length,totalFields:e.form.elements.length}))},5e3))}handleVisibilityChange(){document.hidden?this.track("page_hidden"):(this.track("page_visible"),this.updateActivity())}handleResize(){this.track("window_resize",{width:t.innerWidth,height:t.innerHeight})}detectExitIntent(t){t.clientY<=0&&!this.state.exitIntentDetected&&(this.state.exitIntentDetected=!0,this.track("exit_intent",{timeOnPage:this.getTimeOnPage(),scrollDepth:this.state.maxScrollDepth,engagementLevel:this.calculateEngagement()}))}handleNavigation(){this.state.currentUrl!==t.location.href&&(this.track("page_navigation",{from:this.state.currentUrl,to:t.location.href}),this.state.currentUrl=t.location.href,this.state.currentPath=t.location.pathname,this.pageLoadTime=Date.now(),this.config.trackPageViews&&this.trackPageView({type:"spa_navigation"}))}trackPerformance(){t.performance&&t.performance.timing&&t.addEventListener("load",()=>{setTimeout(()=>{const e=t.performance.timing,n=t.performance.navigation,o={dnsLookup:e.domainLookupEnd-e.domainLookupStart,tcpConnection:e.connectEnd-e.connectStart,serverResponse:e.responseEnd-e.requestStart,domProcessing:e.domComplete-e.domLoading,pageLoad:e.loadEventEnd-e.navigationStart,domContentLoaded:e.domContentLoadedEventEnd-e.navigationStart,navigationType:["navigate","reload","back_forward","prerender"][n.type]||"unknown",redirectCount:n.redirectCount};if(this.state.pageLoadDuration=o.pageLoad,this.track("performance",o),t.performance.getEntriesByType){const e=t.performance.getEntriesByType("resource");this.track("resource_timing",{totalResources:e.length,totalSize:e.reduce((t,e)=>t+(e.transferSize||0),0),slowestResource:this.getSlowestResource(e)})}},0)})}getSlowestResource(t){if(!t.length)return null;const e=t.reduce((t,e)=>e.duration>t.duration?e:t);return{name:e.name,duration:Math.round(e.duration),type:e.initiatorType}}setupErrorTracking(){t.addEventListener("error",t=>{this.state.errors++,this.track("error",{message:t.message,source:t.filename,line:t.lineno,column:t.colno,stack:t.error?.stack})}),t.addEventListener("unhandledrejection",t=>{this.state.errors++,this.track("promise_rejection",{reason:t.reason?.toString(),promise:t.promise})})}trackVisibility(){let t=null;document.addEventListener("visibilitychange",()=>{if(document.hidden)t=Date.now();else if(t){const e=Date.now()-t;this.state.idleTime+=e,t=null}})}startActivityMonitoring(){setInterval(()=>{if(!document.hidden){Date.now()-this.lastActivityTime<5e3?this.state.activeTime+=1:this.state.idleTime+=1,this.state.timeOnPage=this.getTimeOnPage()}},1e3)}updateActivity(){this.lastActivityTime=Date.now()}setupExitTracking(){t.addEventListener("beforeunload",()=>{this.track("page_exit",{timeOnPage:this.getTimeOnPage(),activeTime:this.state.activeTime,scrollDepth:this.state.maxScrollDepth,interactions:this.state.totalClicks,engagement:this.calculateEngagement()}),this.sendBeacon()})}sendBeacon(){if(!this.config.apiEndpoint||0===this.eventQueue.length)return;const t=JSON.stringify({events:this.eventQueue,meta:this.getMetadata()});navigator.sendBeacon(this.config.apiEndpoint,t),this.log("Beacon sent:",this.eventQueue.length,"events")}track(e,n={}){if(!this.enabled)return;const o={event:e,data:n,sessionId:this.sessionId,visitorId:this.visitorId,userId:this.userId,projectId:this.config.projectId,timestamp:Date.now(),timeOnPage:this.getTimeOnPage(),url:t.location.href,path:t.location.pathname,referrer:document.referrer,screenWidth:this.state.screenWidth,screenHeight:this.state.screenHeight,viewportWidth:t.innerWidth,viewportHeight:t.innerHeight};if(this.config.beforeSend){const t=this.config.beforeSend(o);if(!1===t)return;t&&Object.assign(o,t)}if(this.eventQueue.push(o),this.log("Event tracked:",e,n),this.eventQueue.length>=this.config.batchSize&&this.flush(),this.emit("track",o),this.config.immediatePopoverEvents.includes(e)){if(this.log("Event is in immediate trigger list:",e),!this.config.enablePopovers)return void this.log("âš ï¸ Popover system is disabled. Set enablePopovers: true");if(!this.config.popoverApiKey)return void this.log("âš ï¸ No popover API key configured. Please set popoverApiKey");this.log("âœ… Event triggers immediate popover check:",e),this.flush(),setTimeout(()=>{this.log("âš¡ Requesting popover for event:",e),this.checkForPopover("event:"+e)},100)}}startBatchTimer(){this.batchTimer=setInterval(()=>{this.eventQueue.length>0&&this.flush()},this.config.batchInterval)}stopBatchTimer(){this.batchTimer&&(clearInterval(this.batchTimer),this.batchTimer=null)}async flush(){if(0===this.eventQueue.length)return;if(!this.config.apiEndpoint)return void this.log("No API endpoint configured, events not sent");const t=[...this.eventQueue];this.eventQueue=[];try{const e=await fetch(this.config.apiEndpoint,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({events:t,meta:this.getMetadata()})});if(!e.ok)throw new Error(`HTTP ${e.status}: ${e.statusText}`);this.log("Successfully sent",t.length,"events"),this.emit("flush",{success:!0,count:t.length})}catch(e){this.log("Error sending events:",e),this.eventQueue.unshift(...t),this.config.onError&&this.config.onError(e,t),this.emit("flush",{success:!1,error:e,count:t.length})}}getElementData(t){return{tagName:t.tagName?.toLowerCase(),id:t.id||null,className:t.className||null,text:(t.textContent||t.innerText||"").trim().substring(0,100),href:t.href||null,type:t.type||null,name:t.name||null,value:t.value||null,dataset:t.dataset?{...t.dataset}:null}}isFormField(t){return["INPUT","TEXTAREA","SELECT"].includes(t.tagName)}getFieldKey(t){return`${t.form?.id||"form"}_${t.name||t.id}`}getTimeOnPage(){return Math.floor((Date.now()-this.pageLoadTime)/1e3)}calculateEngagement(){let t=0;t+=Math.min(this.getTimeOnPage()/10,30),t+=this.state.maxScrollDepth/100*25,t+=Math.min(2*this.state.totalClicks,25);return t+=20*(this.state.activeTime/(this.state.activeTime+this.state.idleTime||1)),Math.min(100,Math.round(t))}getMetadata(){return{sessionId:this.sessionId,visitorId:this.visitorId,userId:this.userId,projectId:this.config.projectId,state:this.state,engagement:this.calculateEngagement(),timestamp:Date.now(),userAgent:navigator.userAgent,language:navigator.language,timezone:Intl.DateTimeFormat().resolvedOptions().timeZone}}throttle(t,e){let n;return function(...o){clearTimeout(n),n=setTimeout(()=>t.apply(this,o),e)}}log(...t){this.config.debug&&console.log("[UniversalTracker]",...t)}emit(e,n){const o=new CustomEvent(`tracker:${e}`,{detail:n});t.dispatchEvent(o)}on(e,n){t.addEventListener(`tracker:${e}`,t=>n(t.detail))}identify(t,e={}){this.userId=t,this.track("identify",{userId:t,traits:e})}page(t,e={}){this.trackPageView({pageName:t,...e})}event(t,e={}){this.track(t,e)}setUserProperties(t){this.track("user_properties",t)}getState(){return{...this.state,engagement:this.calculateEngagement(),timeOnPage:this.getTimeOnPage()}}getSession(){return{sessionId:this.sessionId,visitorId:this.visitorId,userId:this.userId}}getVisitorId(){return this.visitorId}getSessionId(){return this.sessionId}reset(){this.clearStorage("_ut_session"),this.clearStorage("_ut_visitor"),this.sessionId=this.getOrCreateSession(),this.visitorId=this.getOrCreateVisitor(),this.userId=null,this.track("reset")}isMobileDevice(){const e=navigator.userAgent||navigator.vendor||t.opera,n=/android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini|mobile|tablet/i.test(e.toLowerCase()),o=t.innerWidth<=768,i="ontouchstart"in t||navigator.maxTouchPoints>0;return n||o&&i}startPopoverSystem(){this.isMobileDevice()?this.log("ðŸ“± Popover system disabled on mobile devices"):this.config.popoverEnablePeriodicChecks?setTimeout(()=>{this.checkForPopover("periodic"),this.popoverState.checkTimer=setInterval(()=>{this.checkForPopover("periodic")},this.config.popoverCheckInterval),this.log("ðŸ”„ Popover system started with periodic checks every",this.config.popoverCheckInterval/1e3,"seconds")},this.config.popoverMinDelay):this.log("â¸ï¸ Periodic popover checks disabled. Only event-based checks will run.")}async checkForPopover(e="manual"){if(this.log(`ðŸ” checkForPopover() called [trigger: ${e}]`),this.popoverState.count>=this.config.popoverMaxPerSession)this.log("âŒ Max popovers reached for session:",this.popoverState.count,"/",this.config.popoverMaxPerSession);else if(this.popoverState.currentPopover)this.log("âŒ Popover already displayed:",this.popoverState.currentPopover.title);else try{const e=this.config.apiEndpoint.replace(/\/track\/?$/,""),n=e+"/"+(this.config.popoverUseFastEndpoint,"suggest-popover/");this.log("ðŸ“¡ Requesting popover from:",n),this.log("ðŸ“¦ Request data:",{session_id:this.sessionId,current_page:t.location.pathname,language_code:navigator.language.split("-")[0]||"en"});const o=await fetch(n,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.config.popoverApiKey}`},body:JSON.stringify({session_id:this.sessionId,current_page:t.location.pathname,language_code:navigator.language.split("-")[0]||"en"})}),i=await o.json();if(this.log("ðŸ“¥ Popover response:",i),i.success&&i.popover_suggestion&&i.popover_suggestion.suggested){const t=i.popover_suggestion.popover;if(this.log("âœ… Popover suggested:",t.title,"Score:",i.popover_suggestion.score),this.popoverState.shown.has(t.id)&&t.show_once_per_session)return void this.log("âš ï¸ Popover already shown this session:",t.id);this.showPopover(t,i.popover_suggestion)}else this.log("â„¹ï¸ No popover suggested for current context"),i.popover_suggestion&&this.log("Reason:",i.popover_suggestion.reasons||"No reasons provided")}catch(t){this.log("âŒ Error checking for popover:",t),this.log("Error details:",t.message,t.stack)}}showPopover(t,e){if(this.isMobileDevice())return void this.log("ðŸ“± Popover not shown - mobile device detected");if(this.isChatOpen())return void this.log("Popover not shown - chat is currently open");const n=1e3*t.delay_seconds;setTimeout(()=>{this.isChatOpen()?this.log("Popover cancelled - chat opened during delay"):(this.renderPopover(t,e),this.popoverState.currentPopover=t,this.popoverState.shown.add(t.id),this.popoverState.count++,this.trackPopoverInteraction(t.id,"view"),t.auto_dismiss_seconds&&setTimeout(()=>{this.hidePopover()},1e3*t.auto_dismiss_seconds),this.log("Popover displayed:",t.title))},n)}isChatOpen(){const t=document.getElementById("tharwah-chat-window");return t&&t.classList.contains("active")}renderPopover(e,n){const o=document.createElement("div");if(o.id="tharwah-chat-popover",o.className="tharwah-popover",o.dataset.popoverId=e.id,o.innerHTML=`\n        <div class="tharwah-popover-card">\n          \x3c!-- Close button --\x3e\n          <button class="tharwah-popover-close" aria-label="Close">\n            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n              <path d="M18 6 6 18"></path>\n              <path d="m6 6 12 12"></path>\n            </svg>\n          </button>\n          \n          \x3c!-- Horizontal Content Layout --\x3e\n          <div class="tharwah-popover-horizontal">\n            \x3c!-- Icon on Left --\x3e\n            <div class="tharwah-popover-icon-wrapper">\n              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n                <path d="m15.477 12.89 1.515 8.526a.5.5 0 0 1-.81.47l-3.58-2.687a1 1 0 0 0-1.197 0l-3.586 2.686a.5.5 0 0 1-.81-.469l1.514-8.526"></path>\n                <circle cx="12" cy="8" r="6"></circle>\n              </svg>\n            </div>\n            \n            \x3c!-- Text Content on Right --\x3e\n            <div class="tharwah-popover-text-content">\n              <p class="tharwah-popover-description">${e.content}</p>\n              <button class="tharwah-popover-cta">Start Chat</button>\n            </div>\n          </div>\n        </div>\n      `,document.getElementById("tharwah-chat-popover-styles")||this.injectPopoverStyles(),e.custom_css){const t=document.createElement("style");t.textContent=e.custom_css,o.appendChild(t)}document.body.appendChild(o),setTimeout(()=>o.classList.add("tharwah-popover-visible"),10);const i=o.querySelector(".tharwah-popover-close");i&&i.addEventListener("click",()=>{this.trackPopoverInteraction(e.id,"dismiss"),this.hidePopover()});const r=o.querySelector(".tharwah-popover-cta");r&&r.addEventListener("click",()=>{this.trackPopoverInteraction(e.id,"click"),this.hidePopover(),t.tharwahChatWidget&&"function"==typeof t.tharwahChatWidget.open?(t.tharwahChatWidget.open(),this.log("Opened chat widget from popover")):t.tharwahChat&&"function"==typeof t.tharwahChat.open?(t.tharwahChat.open(),this.log("Opened chat widget from popover")):this.log("Warning: TharwahChat widget not found. Make sure to load TharwahChat-V1.js before popovers appear.")}),o.addEventListener("click",t=>{"A"!==t.target.tagName&&"BUTTON"!==t.target.tagName||t.target.classList.contains("tharwah-popover-close")||t.target.classList.contains("tharwah-popover-action")||this.trackPopoverInteraction(e.id,"click")})}hidePopover(){const t=document.getElementById("tharwah-chat-popover");t&&(t.classList.remove("tharwah-popover-visible"),setTimeout(()=>{t.remove(),this.popoverState.currentPopover=null},300))}trackPopoverInteraction(e,n){if(this.config.apiEndpoint&&this.config.popoverApiKey)try{const o=this.config.apiEndpoint.replace(/\/track\/?$/,"");fetch(o+"/popover-interaction/",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.config.popoverApiKey}`},body:JSON.stringify({popover_id:e,action:n,session_id:this.sessionId,url:t.location.href})}),this.log("Popover interaction tracked:",n,e)}catch(t){this.log("Error tracking popover interaction:",t)}}injectPopoverStyles(){const t=document.createElement("style");t.id="tharwah-chat-popover-styles",t.textContent="\n        /* Popover Container */\n        .tharwah-popover {\n          position: fixed !important;\n          bottom: 100px !important;\n          right: 30px !important;\n          z-index: 999998 !important;\n          max-width: 380px !important;\n          width: auto !important;\n          opacity: 0;\n          transform: translateY(20px) scale(0.95);\n          transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);\n          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif !important;\n        }\n        \n        .tharwah-popover-visible {\n          opacity: 1 !important;\n          transform: translateY(0) scale(1) !important;\n        }\n        \n        /* Popover Card */\n        .tharwah-popover-card {\n          background: white !important;\n          border-radius: 12px !important;\n          box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15) !important;\n          border: 0 !important;\n          position: relative !important;\n        }\n        \n        /* Close Button */\n        .tharwah-popover-close {\n          position: absolute !important;\n          top: 8px !important;\n          right: 8px !important;\n          background: transparent !important;\n          border: none !important;\n          width: 24px !important;\n          height: 24px !important;\n          display: flex !important;\n          align-items: center !important;\n          justify-content: center !important;\n          cursor: pointer !important;\n          transition: all 0.2s !important;\n          color: #9ca3af !important;\n          z-index: 10 !important;\n          padding: 0 !important;\n        }\n        \n        .tharwah-popover-close:hover {\n          color: #6b7280 !important;\n        }\n        \n        .tharwah-popover-close svg {\n          width: 16px !important;\n          height: 16px !important;\n        }\n        \n        /* Horizontal Content Layout */\n        .tharwah-popover-horizontal {\n          padding: 16px !important;\n          padding-right: 40px !important;\n          display: flex !important;\n          align-items: flex-start !important;\n          gap: 12px !important;\n        }\n        \n        /* Icon Wrapper - Green color scheme */\n        .tharwah-popover-icon-wrapper {\n          width: 32px !important;\n          height: 32px !important;\n          background: #d1fae5 !important;\n          color: #059669 !important;\n          border-radius: 8px !important;\n          display: flex !important;\n          align-items: center !important;\n          justify-content: center !important;\n          flex-shrink: 0 !important;\n        }\n        \n        .tharwah-popover-icon-wrapper svg {\n          width: 16px !important;\n          height: 16px !important;\n          stroke: #059669 !important;\n        }\n        \n        /* Text Content */\n        .tharwah-popover-text-content {\n          flex: 1 !important;\n          display: flex !important;\n          flex-direction: column !important;\n          gap: 4px !important;\n        }\n        \n        .tharwah-popover-title {\n          margin: 0 !important;\n          margin-bottom: 4px !important;\n          font-size: 14px !important;\n          font-weight: 600 !important;\n          color: #111827 !important;\n          line-height: 1.3 !important;\n        }\n        \n        .tharwah-popover-description {\n          margin: 0 !important;\n          margin-bottom: 12px !important;\n          font-size: 12px !important;\n          line-height: 1.5 !important;\n          color: #6b7280 !important;\n        }\n        \n        /* CTA Button - Green color scheme */\n        .tharwah-popover-cta {\n          width: 100% !important;\n          padding: 8px 12px !important;\n          background: #059669 !important;\n          color: white !important;\n          border: none !important;\n          border-radius: 6px !important;\n          font-size: 12px !important;\n          font-weight: 500 !important;\n          cursor: pointer !important;\n          transition: all 0.2s !important;\n          box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05) !important;\n          text-align: center !important;\n          height: 32px !important;\n        }\n        \n        .tharwah-popover-cta:hover {\n          background: #047857 !important;\n        }\n        \n        .tharwah-popover-cta:active {\n          transform: scale(0.98) !important;\n        }\n        \n        /* Positioning - Above chat button */\n        .tharwah-popover-bottom,\n        .tharwah-popover-bottom-end {\n          bottom: 90px;\n          right: 20px;\n        }\n        \n        .tharwah-popover-top,\n        .tharwah-popover-top-end {\n          top: 20px;\n          right: 20px;\n        }\n        \n        .tharwah-popover-bottom-start {\n          bottom: 90px;\n          left: 20px;\n        }\n        \n        .tharwah-popover-top-start {\n          top: 20px;\n          left: 20px;\n        }\n        \n        .tharwah-popover-left {\n          top: 50%;\n          left: 20px;\n          transform: translateY(-50%);\n        }\n        \n        .tharwah-popover-right {\n          top: 50%;\n          right: 20px;\n          transform: translateY(-50%);\n        }\n        \n        .tharwah-popover-content {\n          display: flex;\n          padding: 20px;\n          gap: 12px;\n          position: relative;\n        }\n        \n        .tharwah-popover-icon {\n          font-size: 32px;\n          flex-shrink: 0;\n        }\n        \n        .tharwah-popover-body {\n          flex: 1;\n        }\n        \n        .tharwah-popover-title {\n          margin: 0 0 8px 0;\n          font-size: 18px;\n          font-weight: 600;\n          color: #1a202c;\n        }\n        \n        .tharwah-popover-text {\n          margin: 0 0 16px 0;\n          font-size: 14px;\n          line-height: 1.5;\n          color: #6b7280;\n        }\n        \n        .tharwah-popover-action {\n          width: 100%;\n          padding: 12px 24px;\n          background: #2563eb;\n          color: white;\n          border: none;\n          border-radius: 8px;\n          font-size: 15px;\n          font-weight: 600;\n          cursor: pointer;\n          transition: background 0.2s;\n        }\n        \n        .tharwah-popover-action:hover {\n          background: #1d4ed8;\n        }\n        \n        .tharwah-popover-action:active {\n          transform: scale(0.98);\n        }\n        \n        .tharwah-popover-close {\n          position: absolute;\n          top: 12px;\n          right: 12px;\n          background: none;\n          border: none;\n          font-size: 24px;\n          color: #9ca3af;\n          cursor: pointer;\n          width: 28px;\n          height: 28px;\n          display: flex;\n          align-items: center;\n          justify-content: center;\n          border-radius: 4px;\n          transition: all 0.2s;\n        }\n        \n        .tharwah-popover-close:hover {\n          background: #f3f4f6;\n          color: #374151;\n        }\n        \n        /* Color schemes */\n        .tharwah-popover-default {\n          border-left: 4px solid #667eea;\n        }\n        \n        .tharwah-popover-info {\n          border-left: 4px solid #4299e1;\n        }\n        \n        .tharwah-popover-success {\n          border-left: 4px solid #48bb78;\n        }\n        \n        .tharwah-popover-warning {\n          border-left: 4px solid #ed8936;\n        }\n        \n        .tharwah-popover-error {\n          border-left: 4px solid #f56565;\n        }\n        \n        /* MOBILE PORTRAIT - UPDATED FOR BETTER UX */\n        @media (max-width: 640px) {\n          .tharwah-popover {\n            /* Full width with proper margins */\n            bottom: 90px !important;\n            left: 12px !important;\n            right: 12px !important;\n            max-width: none !important;\n            width: calc(100% - 24px) !important;\n            \n            /* iPhone X+ notch support */\n            bottom: max(90px, calc(80px + env(safe-area-inset-bottom))) !important;\n            left: max(12px, env(safe-area-inset-left)) !important;\n            right: max(12px, env(safe-area-inset-right)) !important;\n            \n            /* Mobile animation */\n            transform: translateY(30px) !important;\n          }\n          \n          .tharwah-popover-visible {\n            transform: translateY(0) !important;\n          }\n          \n          .tharwah-popover-card {\n            border-radius: 16px !important;\n            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2) !important;\n          }\n          \n          /* Horizontal layout with more padding */\n          .tharwah-popover-horizontal {\n            padding: 20px !important;\n            padding-right: 52px !important;\n            gap: 14px !important;\n          }\n          \n          /* Larger icon on mobile */\n          .tharwah-popover-icon-wrapper {\n            width: 44px !important;\n            height: 44px !important;\n            border-radius: 12px !important;\n          }\n          \n          .tharwah-popover-icon-wrapper svg {\n            width: 24px !important;\n            height: 24px !important;\n          }\n          \n          /* Larger, readable text */\n          .tharwah-popover-description {\n            font-size: 15px !important;\n            line-height: 1.6 !important;\n            color: #1f2937 !important;\n            margin-bottom: 12px !important;\n          }\n          \n          /* Touch-friendly button (48px minimum) */\n          .tharwah-popover-cta {\n            padding: 14px 20px !important;\n            font-size: 15px !important;\n            min-height: 48px !important;\n            border-radius: 12px !important;\n            font-weight: 600 !important;\n          }\n          \n          /* Larger close button for easier tapping */\n          .tharwah-popover-close {\n            width: 40px !important;\n            height: 40px !important;\n            top: 10px !important;\n            right: 10px !important;\n            background: rgba(255, 255, 255, 0.95) !important;\n            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1) !important;\n          }\n          \n          .tharwah-popover-close svg {\n            width: 20px !important;\n            height: 20px !important;\n          }\n        }\n        \n        /* ========================================\n           MOBILE RESPONSIVE STYLES\n           ======================================== */\n        \n        /* Tablets and small laptops */\n        @media (max-width: 1024px) {\n          .tharwah-popover {\n            max-width: 340px !important;\n            right: 20px !important;\n          }\n        }\n        \n        /* ========================================\n           ULTRA-COMPACT MOBILE DESIGN\n           Minimal & Space-Efficient\n           ======================================== */\n        @media (max-width: 768px) {\n          /* Floating Card Container - Ultra Compact */\n          .tharwah-popover {\n            bottom: 16px !important;\n            left: 12px !important;\n            right: 12px !important;\n            max-width: none !important;\n            width: auto !important;\n            opacity: 0;\n            transform: translateY(12px) scale(0.95);\n            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1) !important;\n          }\n          \n          .tharwah-popover-visible {\n            opacity: 1 !important;\n            transform: translateY(0) scale(1) !important;\n          }\n          \n          /* Card Styling - Minimal Shadow */\n          .tharwah-popover-card {\n            border-radius: 12px !important;\n            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12) !important;\n            background: white !important;\n          }\n          \n          /* Close Button - Tiny */\n          .tharwah-popover-close {\n            width: 24px !important;\n            height: 24px !important;\n            top: 6px !important;\n            right: 6px !important;\n            background: rgba(0, 0, 0, 0.04) !important;\n            border-radius: 50% !important;\n          }\n          \n          .tharwah-popover-close:hover {\n            background: rgba(0, 0, 0, 0.08) !important;\n          }\n          \n          .tharwah-popover-close svg {\n            width: 12px !important;\n            height: 12px !important;\n          }\n          \n          /* Content Layout - Horizontal & Ultra Compact */\n          .tharwah-popover-horizontal {\n            padding: 10px 12px !important;\n            padding-right: 34px !important;\n            gap: 8px !important;\n            flex-direction: row !important;\n            align-items: center !important;\n          }\n          \n          /* Icon - Tiny, Left Side */\n          .tharwah-popover-icon-wrapper {\n            width: 32px !important;\n            height: 32px !important;\n            border-radius: 8px !important;\n            margin: 0 !important;\n            box-shadow: none !important;\n            flex-shrink: 0 !important;\n          }\n          \n          .tharwah-popover-icon-wrapper svg {\n            width: 16px !important;\n            height: 16px !important;\n          }\n          \n          /* Text Content - Minimal Spacing */\n          .tharwah-popover-text-content {\n            flex: 1 !important;\n            text-align: left !important;\n          }\n          \n          .tharwah-popover-title {\n            font-size: 13px !important;\n            font-weight: 600 !important;\n            margin-bottom: 2px !important;\n            color: #111827 !important;\n            line-height: 1.2 !important;\n          }\n          \n          .tharwah-popover-description {\n            font-size: 11px !important;\n            line-height: 1.3 !important;\n            margin-bottom: 8px !important;\n            color: #6b7280 !important;\n          }\n          \n          /* CTA Button - Ultra Compact */\n          .tharwah-popover-cta {\n            width: 100% !important;\n            padding: 6px 12px !important;\n            font-size: 12px !important;\n            font-weight: 600 !important;\n            height: 32px !important;\n            min-height: 32px !important;\n            border-radius: 8px !important;\n            background: #059669 !important;\n            transition: all 0.2s !important;\n          }\n          \n          .tharwah-popover-cta:hover {\n            background: #047857 !important;\n            transform: translateY(-1px) !important;\n          }\n          \n          .tharwah-popover-cta:active {\n            transform: translateY(0) !important;\n          }\n        }\n        \n\n        \n        /* LANDSCAPE MODE (short screens) */\n        @media (max-height: 500px) {\n          .tharwah-popover {\n            bottom: 60px !important;\n            max-width: 360px !important;\n          }\n          \n          .tharwah-popover-horizontal {\n            padding: 14px !important;\n            padding-right: 48px !important;\n          }\n        }\n      ",document.head.appendChild(t)}escapeHtml(t){const e=document.createElement("div");return e.textContent=t,e.innerHTML}}"undefined"!=typeof module&&module.exports&&(module.exports=e),t.UniversalTracker=e,t.trackerConfig&&(t.tracker=new e(t.trackerConfig).init())}(window);