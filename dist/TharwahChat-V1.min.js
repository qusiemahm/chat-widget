!function(e,t){"use strict";class n{constructor(e={}){this.config={apiEndpoint:e.apiEndpoint||"http://localhost:8000/api",apiKey:e.apiKey,botId:e.botId||1,organizationId:e.organizationId||null,welcomeMessage:"",position:e.position||"bottom-right",primaryColor:e.primaryColor||"#667eea",secondaryColor:e.secondaryColor||"#764ba2",buttonIcon:e.buttonIcon||"üí¨",title:"",subtitle:"",debug:e.debug||!1,autoOpen:e.autoOpen||!1,autoOpenDelay:e.autoOpenDelay||3e3,showSuggestions:!1!==e.showSuggestions,suggestionsLimit:e.suggestionsLimit||6,enableStreaming:e.enableStreaming||!0,language:e.language||this.detectLanguage(),...e},this.isOpen=!1,this.conversationId=null,this.messages=[],this.suggestions=[],this.isTyping=!1,this.isRendered=!1,this.showingWelcome=!0,this.currentStreamingMessage=null,this.feedbackShown=!1,this.feedbackSubmitted=!1,this.isWaitingForResponse=!1,this.abortController=null,this.log("TharwahChat initialized",this.config),this.log("Streaming enabled:",this.config.enableStreaming),this.config.apiKey||console.error("[TharwahChat] ERROR: apiKey is required in config!")}init(){return"loading"===t.readyState?t.addEventListener("DOMContentLoaded",()=>this.render()):this.render(),this}detectLanguage(){const e=t.documentElement.lang;if(e&&e.toLowerCase().startsWith("ar"))return"ar";const n=navigator.language||navigator.userLanguage;return n&&n.toLowerCase().startsWith("ar")?"ar":"en"}getTranslations(){return{en:{welcomeTitle:"Hi there! üëã",welcomeSubtitle:"Let's find what you're looking for",startConversation:"Start a conversation",startConversationDesc:"Ask us anything about our programs",emailScreenTitle:"Chat with Our Tharwah Bot",emailScreenSubtitle:"To get started, please share your email address:",emailPlaceholder:"your@email.com",termsText:"I agree to The Terms & Conditions and acknowledge that my personal information will be processed in accordance with data protection regulations.",submitButton:"Submit",alertEnterEmail:"Please enter your email address",alertAcceptTerms:"Please accept the Terms & Conditions",alertValidEmail:"Please enter a valid email address",alertConversationFailed:"Failed to start conversation. Please try again.",alertSaveFailed:"Failed to save your information. Please try again.",inputPlaceholder:"Type your message...",waitingPlaceholder:"Waiting for response...",quickSuggestionsHeader:"Quick suggestions",quickSuggestionsFooter:"Based on your conversation",enrollNow:"Enroll Now",downloadBrochure:"Download Brochure",audioFeature:"Audio description feature coming soon!",errorGeneric:"Sorry, I encountered an error. Please try again.",errorConfig:"Configuration error. Please contact support.",toolUsing:"Using",toolExecuting:"Executing",feedbackTitle:"Rate your experience",feedbackSubtitle:"How was your conversation?",feedbackCategoryLabel:"Category (optional)",feedbackCategoryPlaceholder:"Select a category",feedbackTextLabel:"Additional comments (optional)",feedbackTextPlaceholder:"Tell us more about your experience...",feedbackSubmit:"Submit Feedback",feedbackCancel:"Maybe Later",feedbackSuccess:"Thank you for your feedback!",feedbackError:"Failed to submit feedback. Please try again.",feedbackButton:"Rate Experience",categoryHelpful:"Helpful",categoryUnhelpful:"Unhelpful",categoryIncorrect:"Incorrect Information",categorySlow:"Slow Response",categoryBug:"Bug/Issue",categoryFeature:"Feature Request",categoryOther:"Other"},ar:{welcomeTitle:"ŸÖÿ±ÿ≠ÿ®ÿßŸã! üëã",welcomeSubtitle:"ÿØÿπŸÜÿß ŸÜÿ¨ÿØ ŸÖÿß ÿ™ÿ®ÿ≠ÿ´ ÿπŸÜŸá",startConversation:"ÿßÿ®ÿØÿ£ ŸÖÿ≠ÿßÿØÿ´ÿ©",startConversationDesc:"ÿßÿ≥ÿ£ŸÑŸÜÿß ÿ£Ÿä ÿ¥Ÿäÿ° ÿπŸÜ ÿ®ÿ±ÿßŸÖÿ¨ŸÜÿß",emailScreenTitle:"ÿßŸÑÿØÿ±ÿØÿ¥ÿ© ŸÖÿπ ÿ´ÿ±Ÿàÿ© ÿ®Ÿàÿ™",emailScreenSubtitle:"ŸÑŸÑÿ®ÿØÿ°ÿå Ÿäÿ±ÿ¨Ÿâ ŸÖÿ¥ÿßÿ±ŸÉÿ© ÿπŸÜŸàÿßŸÜ ÿ®ÿ±ŸäÿØŸÉ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä:",emailPlaceholder:"your@email.com",termsText:"ÿ£ŸàÿßŸÅŸÇ ÿπŸÑŸâ ÿßŸÑÿ¥ÿ±Ÿàÿ∑ ŸàÿßŸÑÿ£ÿ≠ŸÉÿßŸÖ Ÿàÿ£ŸÇÿ± ÿ®ÿ£ŸÜŸá ÿ≥ÿ™ÿ™ŸÖ ŸÖÿπÿßŸÑÿ¨ÿ© ŸÖÿπŸÑŸàŸÖÿßÿ™Ÿä ÿßŸÑÿ¥ÿÆÿµŸäÿ© ŸàŸÅŸÇÿßŸã ŸÑŸÑŸàÿßÿ¶ÿ≠ ÿ≠ŸÖÿßŸäÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™.",submitButton:"ÿ•ÿ±ÿ≥ÿßŸÑ",alertEnterEmail:"Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ÿπŸÜŸàÿßŸÜ ÿ®ÿ±ŸäÿØŸÉ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä",alertAcceptTerms:"Ÿäÿ±ÿ¨Ÿâ ÿßŸÑŸÖŸàÿßŸÅŸÇÿ© ÿπŸÑŸâ ÿßŸÑÿ¥ÿ±Ÿàÿ∑ ŸàÿßŸÑÿ£ÿ≠ŸÉÿßŸÖ",alertValidEmail:"Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ÿπŸÜŸàÿßŸÜ ÿ®ÿ±ŸäÿØ ÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä ÿµÿßŸÑÿ≠",alertConversationFailed:"ŸÅÿ¥ŸÑ ÿ®ÿØÿ° ÿßŸÑŸÖÿ≠ÿßÿØÿ´ÿ©. Ÿäÿ±ÿ¨Ÿâ ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ.",alertSaveFailed:"ŸÅÿ¥ŸÑ ÿ≠ŸÅÿ∏ ŸÖÿπŸÑŸàŸÖÿßÿ™ŸÉ. Ÿäÿ±ÿ¨Ÿâ ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ.",inputPlaceholder:"ÿßŸÉÿ™ÿ® ÿ±ÿ≥ÿßŸÑÿ™ŸÉ...",waitingPlaceholder:"ŸÅŸä ÿßŸÜÿ™ÿ∏ÿßÿ± ÿßŸÑÿ±ÿØ...",quickSuggestionsHeader:"ÿßŸÇÿ™ÿ±ÿßÿ≠ÿßÿ™ ÿ≥ÿ±Ÿäÿπÿ©",quickSuggestionsFooter:"ÿ®ŸÜÿßÿ°Ÿã ÿπŸÑŸâ ŸÖÿ≠ÿßÿØÿ´ÿ™ŸÉ",enrollNow:"ÿ≥ÿ¨ŸÑ ÿßŸÑÿ¢ŸÜ",downloadBrochure:"ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÉÿ™Ÿäÿ®",audioFeature:"ŸÖŸäÿ≤ÿ© ÿßŸÑŸàÿµŸÅ ÿßŸÑÿµŸàÿ™Ÿä ŸÇÿ±Ÿäÿ®ÿßŸã!",errorGeneric:"ÿπÿ∞ÿ±ÿßŸãÿå ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£. Ÿäÿ±ÿ¨Ÿâ ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ.",errorConfig:"ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™. Ÿäÿ±ÿ¨Ÿâ ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑÿØÿπŸÖ.",toolUsing:"ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ",toolExecuting:"ÿ™ŸÜŸÅŸäÿ∞",feedbackTitle:"ŸÇŸäŸëŸÖ ÿ™ÿ¨ÿ±ÿ®ÿ™ŸÉ",feedbackSubtitle:"ŸÉŸäŸÅ ŸÉÿßŸÜÿ™ ŸÖÿ≠ÿßÿØÿ´ÿ™ŸÉÿü",feedbackCategoryLabel:"ÿßŸÑŸÅÿ¶ÿ© (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä)",feedbackCategoryPlaceholder:"ÿßÿÆÿ™ÿ± ŸÅÿ¶ÿ©",feedbackTextLabel:"ÿ™ÿπŸÑŸäŸÇÿßÿ™ ÿ•ÿ∂ÿßŸÅŸäÿ© (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä)",feedbackTextPlaceholder:"ÿ£ÿÆÿ®ÿ±ŸÜÿß ÿßŸÑŸÖÿ≤ŸäÿØ ÿπŸÜ ÿ™ÿ¨ÿ±ÿ®ÿ™ŸÉ...",feedbackSubmit:"ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ™ŸÇŸäŸäŸÖ",feedbackCancel:"ÿ±ÿ®ŸÖÿß ŸÑÿßÿ≠ŸÇÿßŸã",feedbackSuccess:"ÿ¥ŸÉÿ±ÿßŸã ŸÑŸÉ ÿπŸÑŸâ ÿ™ŸÇŸäŸäŸÖŸÉ!",feedbackError:"ŸÅÿ¥ŸÑ ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ™ŸÇŸäŸäŸÖ. Ÿäÿ±ÿ¨Ÿâ ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ.",feedbackButton:"ŸÇŸäŸëŸÖ ÿßŸÑÿ™ÿ¨ÿ±ÿ®ÿ©",categoryHelpful:"ŸÖŸÅŸäÿØ",categoryUnhelpful:"ÿ∫Ÿäÿ± ŸÖŸÅŸäÿØ",categoryIncorrect:"ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿÆÿßÿ∑ÿ¶ÿ©",categorySlow:"ÿßÿ≥ÿ™ÿ¨ÿßÿ®ÿ© ÿ®ÿ∑Ÿäÿ¶ÿ©",categoryBug:"ÿÆÿ∑ÿ£/ŸÖÿ¥ŸÉŸÑÿ©",categoryFeature:"ÿ∑ŸÑÿ® ŸÖŸäÿ≤ÿ©",categoryOther:"ÿ£ÿÆÿ±Ÿâ"}}}t(e){const t=this.getTranslations(),n=this.config.language||"en";return t[n]?.[e]||t.en[e]||e}async render(){this.isRendered?this.log("Widget already rendered, skipping..."):(this.injectStyles(),this.createWidget(),this.attachEventListeners(),this.config.showSuggestions&&await this.loadSuggestions(),setTimeout(()=>{const e=sessionStorage.getItem("tharwah_user_email"),t=sessionStorage.getItem("tharwah_terms_accepted");!(this.showingWelcome&&this.suggestions.length>0)||e&&t?(this.showingWelcome=!1,this.addMessage(this.getWelcomeMessage(),"bot",null,!0)):this.showWelcomeScreen()},500),this.isRendered=!0,this.config.autoOpen&&setTimeout(()=>{this.open()},this.config.autoOpenDelay),this.log("Widget rendered successfully"))}async loadSuggestions(){try{const e=await fetch(`${this.config.apiEndpoint}/widget/suggestions/welcome/?bot_id=${this.config.botId}&limit=${this.config.suggestionsLimit}&language=${this.config.language}`,{method:"GET",headers:{Authorization:`Bearer ${this.config.apiKey}`}});if(!e.ok)throw new Error(`Failed to load suggestions: ${e.status}`);const t=await e.json();this.suggestions=t.suggestions||[],this.log(`Loaded ${this.suggestions.length} suggestions for language: ${this.config.language}`)}catch(e){this.log("Error loading suggestions:",e),this.suggestions=[]}}showWelcomeScreen(){if(!this.suggestions||0===this.suggestions.length)return void this.addMessage(this.getWelcomeMessage(),"bot",null,!0);this.elements.messages.style.display="none",this.elements.inputContainer.style.display="none";const e=t.createElement("div");e.id="tharwah-welcome-screen",e.style.cssText="\n        position: absolute;\n        top: 0;\n        left: 0;\n        right: 0;\n        bottom: 0;\n        background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 50%, #1e40af 100%);\n        display: flex;\n        flex-direction: column;\n        z-index: 10;\n      ",e.innerHTML=`\n        <div style="flex: 1; display: flex; flex-direction: column; justify-content: center; padding: 24px; overflow-y: auto;">\n          <button\n            style="\n              position: absolute;\n              top: 16px;\n              right: 16px;\n              background: rgba(255, 255, 255, 0.2);\n              border: none;\n              border-radius: 50%;\n              width: 32px;\n              height: 32px;\n              display: flex;\n              align-items: center;\n              justify-content: center;\n              cursor: pointer;\n              color: white;\n              transition: background 0.2s;\n              z-index: 20;\n            "\n            onmouseover="this.style.background='rgba(255, 255, 255, 0.3)'"\n            onmouseout="this.style.background='rgba(255, 255, 255, 0.2)'"\n            onclick="window.tharwahChatWidget.close()"\n            aria-label="Close"\n          >\n            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n              <line x1="18" y1="6" x2="6" y2="18"></line>\n              <line x1="6" y1="6" x2="18" y2="18"></line>\n            </svg>\n          </button>\n          <div style="text-align: center; margin-bottom: 24px;">\n            <h1 style="font-size: 28px; font-weight: 700; color: white; margin: 0 0 8px 0;">${this.t("welcomeTitle")}</h1>\n            <p style="font-size: 16px; color: rgba(255, 255, 255, 0.9); margin: 0;">${this.t("welcomeSubtitle")}</p>\n          </div>\n          \n          <div style="background: white; border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); padding: 12px; margin-bottom: 16px;">\n            <div style="display: flex; flex-direction: column; gap: 2px;">\n              ${this.suggestions.map(e=>`\n                <button\n                  class="tharwah-welcome-suggestion"\n                  id="tharwah-chat-suggestion-${e.id}"\n                  data-suggestion-id="${e.id}"\n                  data-action-text="${this.escapeHtml(e.action_text).replace(/"/g,"&quot;")}"\n                  style="\n                    width: 100%;\n                    display: flex;\n                    align-items: center;\n                    justify-content: space-between;\n                    padding: 12px;\n                    background: white;\n                    border: none;\n                    border-radius: 8px;\n                    cursor: pointer;\n                    transition: background 0.2s;\n                    text-align: left;\n                  "\n                  onmouseover="this.style.background='#f9fafb';"\n                  onmouseout="this.style.background='white';"\n                  onclick="window.tharwahChatWidget.handleWelcomeSuggestionClick(${e.id}, this.getAttribute('data-action-text'))"\n                >\n                  <span style="color: #1f2937; font-size: 14px; font-weight: 500;">${this.escapeHtml(e.title)}</span>\n                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#9ca3af" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="flex-shrink: 0; transition: stroke 0.2s;">\n                    <path d="m9 18 6-6-6-6"></path>\n                  </svg>\n                </button>\n              `).join("")}\n            </div>\n          </div>\n          \n          <button \n            id="tharwah-start-conversation"\n            style="\n              background: white;\n              border-radius: 16px;\n              box-shadow: 0 4px 12px rgba(0,0,0,0.15);\n              padding: 16px;\n              border: none;\n              cursor: pointer;\n              width: 100%;\n              transition: all 0.3s;\n            "\n            onmouseover="this.style.boxShadow='0 6px 20px rgba(0,0,0,0.2)';"\n            onmouseout="this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)';"\n            onclick="window.tharwahChatWidget.startConversation()"\n          >\n            <div style="display: flex; align-items: center; justify-content: space-between;" dir="ltr">\n              <div style=" ${"ar"===this.config.language?"text-align : right; margin-right: 10px; ":"text-align : left"}; flex: 1;">\n                <h3 style="font-size: 15px; font-weight: 600; color: #1f2937; margin: 0 0 4px 0;">${this.t("startConversation")}</h3>\n                <p style="font-size: 13px; color: #6b7280; margin: 0;">${this.t("startConversationDesc")}</p>\n              </div>\n              <div style="background: #2563eb; padding: 10px; border-radius: 50%; transition: background 0.2s;">\n                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n                  <path d="M7.9 20A9 9 0 1 0 4 16.1L2 22Z"></path>\n                </svg>\n              </div>\n            </div>\n          </button>\n        </div>\n      `,this.elements.window.appendChild(e)}async handleWelcomeSuggestionClick(e,t){this.log("Welcome suggestion clicked:",e,t);const n=sessionStorage.getItem("tharwah_user_email"),a=sessionStorage.getItem("tharwah_terms_accepted");n&&a?await this.proceedAfterEmailCapture(e,t):this.showEmailCaptureScreen({type:"suggestion",source:"suggestion_click",suggestionId:e,actionText:t})}showEmailCaptureScreen(e={}){const n=t.getElementById("tharwah-welcome-screen");n&&n.remove();const a=t.createElement("div");a.id="tharwah-email-screen",a.style.cssText="\n        position: absolute;\n        top: 0;\n        left: 0;\n        right: 0;\n        bottom: 0;\n        background: white;\n        display: flex;\n        flex-direction: column;\n        z-index: 10;\n        padding: 24px;\n      ",a.innerHTML=`\n        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px;">\n          <h2 style="font-size: 18px; font-weight: 600; color: #111827; margin: 0;">${this.t("emailScreenTitle")}</h2>\n          <button\n            onclick="window.tharwahChatWidget.closeEmailScreen()"\n            style="background: none; border: none; color: #6b7280; cursor: pointer; padding: 4px; display: flex; align-items: center; justify-content: center;"\n          >\n            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n              <path d="M18 6 6 18"></path>\n              <path d="m6 6 12 12"></path>\n            </svg>\n          </button>\n        </div>\n\n        <div style="flex: 1; display: flex; flex-direction: column;">\n          <div style="background: #f9fafb; border-radius: 12px; padding: 20px; margin-bottom: 24px;">\n            <p style="font-size: 14px; color: #374151; margin: 0; line-height: 1.6;">\n              ${this.t("emailScreenSubtitle")}\n            </p>\n          </div>\n\n          <form id="tharwah-chat-email-form" style="display: flex; flex-direction: column; gap: 16px;">\n            <div>\n              <input\n                type="email"\n                id="tharwah-chat-email-input"\n                placeholder="${this.t("emailPlaceholder")}"\n                required\n                style="\n                  width: 100%;\n                  padding: 12px 16px;\n                  border: 2px solid #e5e7eb;\n                  border-radius: 8px;\n                  outline: none;\n                  transition: border-color 0.2s;\n                  transform-origin: left;\n                  transform: scale(0.875);\n                "\n                onfocus="this.style.borderColor='#2563eb'"\n                onblur="this.style.borderColor='#e5e7eb'"\n                oninput="window.tharwahChatWidget.validateEmailForm()"\n              />\n            </div>\n\n            <label style="display: flex; align-items: start; gap: 8px; cursor: pointer;">\n              <input\n                type="checkbox"\n                id="tharwah-chat-terms-checkbox"\n                required\n                style="\n                  width: 18px;\n                  height: 18px;\n                  margin-top: 2px;\n                  cursor: pointer;\n                  accent-color: #2563eb;\n                  flex-shrink: 0;\n                "\n                onchange="window.tharwahChatWidget.validateEmailForm()"\n              />\n              <span style="font-size: 12px; color: #6b7280; line-height: 1.5;">\n                ${this.t("termsText")}\n              </span>\n            </label>\n\n            <button\n              type="submit"\n              id="tharwah-chat-submit-button"\n              disabled\n              style="\n                width: 100%;\n                padding: 14px;\n                background: #d1d5db;\n                color: #9ca3af;\n                border: none;\n                border-radius: 8px;\n                font-size: 15px;\n                font-weight: 600;\n                cursor: not-allowed;\n                transition: all 0.2s;\n                box-shadow: none;\n              "\n            >\n              ${this.t("submitButton")}\n            </button>\n          </form>\n        </div>\n      `,this.elements.window.appendChild(a),this.emailCaptureCallback=e;t.getElementById("tharwah-chat-email-form").addEventListener("submit",e=>{e.preventDefault(),this.handleEmailSubmit()})}async handleEmailSubmit(){const e=t.getElementById("tharwah-chat-email-input"),n=t.getElementById("tharwah-chat-terms-checkbox"),a=e.value.trim(),i=n.checked;if(!a)return void alert(this.t("alertEnterEmail"));if(!i)return void alert(this.t("alertAcceptTerms"));if(/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(a)){if(!this.conversationId){this.log("Creating conversation before email capture...");try{await this.createConversation()}catch(e){return this.log("Error creating conversation:",e),void alert(this.t("alertConversationFailed"))}}try{this.log("Updating conversation with email:",a);const e=await fetch(`${this.config.apiEndpoint}/widget/conversations/${this.conversationId}/`,{method:"PATCH",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.config.apiKey}`},body:JSON.stringify({user_email:a,terms_and_conditions_agreed:!0})});if(!e.ok){const t=await e.json().catch(()=>({}));throw new Error(`Failed to update conversation: ${e.status} ${JSON.stringify(t)}`)}const n=await e.json();this.log("Conversation updated successfully:",n),sessionStorage.setItem("tharwah_user_email",a),sessionStorage.setItem("tharwah_terms_accepted","true"),sessionStorage.setItem("tharwah_email_timestamp",Date.now().toString()),this.trackEvent("email_captured",{email:a,source:this.emailCaptureCallback?.source||"welcome_screen",conversation_id:this.conversationId});const i=t.getElementById("tharwah-email-screen");i&&i.remove(),"suggestion"===this.emailCaptureCallback?.type&&this.emailCaptureCallback?.suggestionId&&this.emailCaptureCallback?.actionText?await this.proceedAfterEmailCapture(this.emailCaptureCallback.suggestionId,this.emailCaptureCallback.actionText):"startConversation"===this.emailCaptureCallback?.type&&await this.proceedToNormalChat()}catch(e){this.log("Error updating conversation with email:",e),alert(this.t("alertSaveFailed"))}}else alert(this.t("alertValidEmail"))}validateEmailForm(){const e=t.getElementById("tharwah-chat-email-input"),n=t.getElementById("tharwah-chat-terms-checkbox"),a=t.getElementById("tharwah-chat-submit-button");if(!e||!n||!a)return;const i=e.value.trim(),o=n.checked;/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(i)&&o?(a.disabled=!1,a.style.background="linear-gradient(135deg, #60a5fa 0%, #3b82f6 50%, #2563eb 100%)",a.style.color="white",a.style.cursor="pointer",a.style.boxShadow="0 2px 8px rgba(37, 99, 235, 0.3)",a.style.transition="all 0.2s",a.setAttribute("onmouseover","this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(37, 99, 235, 0.4)'"),a.setAttribute("onmouseout","this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(37, 99, 235, 0.3)'")):(a.disabled=!0,a.style.background="#d1d5db",a.style.color="#9ca3af",a.style.cursor="not-allowed",a.style.boxShadow="none",a.removeAttribute("onmouseover"),a.removeAttribute("onmouseout"))}closeEmailScreen(){const e=t.getElementById("tharwah-email-screen");e&&e.remove(),this.showWelcomeScreen()}async proceedAfterEmailCapture(n,a){this.elements.messages.style.display="",this.elements.inputContainer.style.display="",this.showingWelcome=!1;try{await fetch(`${this.config.apiEndpoint}/widget/suggestions/${n}/track-click/`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.config.apiKey}`},body:JSON.stringify({session_id:this.getSessionId(),page_url:e.location.href,page_title:t.title,user_email:sessionStorage.getItem("tharwah_user_email")})})}catch(e){this.log("Error tracking suggestion click:",e)}this.elements.input.value=a,await this.sendMessage()}async startConversation(){this.log("Starting conversation from welcome screen");const e=sessionStorage.getItem("tharwah_user_email"),t=sessionStorage.getItem("tharwah_terms_accepted");e&&t?await this.proceedToNormalChat():this.showEmailCaptureScreen({type:"startConversation",source:"start_conversation"})}async proceedToNormalChat(){const e=t.getElementById("tharwah-welcome-screen");e&&e.remove(),this.elements.messages.style.display="",this.elements.inputContainer.style.display="",this.showingWelcome=!1,this.addMessage(this.getWelcomeMessage(),"bot",null,!0),this.elements.input.focus()}getWelcomeMessage(){return"ar"===this.config.language?"ŸÖÿ±ÿ≠ÿ®ÿßŸã! üëã ŸÉŸäŸÅ ŸäŸÖŸÉŸÜŸÜŸä ŸÖÿ≥ÿßÿπÿØÿ™ŸÉ ÿßŸÑŸäŸàŸÖÿü":"Hi! üëã How can I help you today?"}getTitle(){return this.config.title?this.config.title:"ar"===this.config.language?"ÿßŸÑÿØÿ±ÿØÿ¥ÿ© ŸÖÿπ ÿ´ÿ±Ÿàÿ© ÿ®Ÿàÿ™":"Chat with Our Tharwah Bot"}getSubtitle(){return this.config.subtitle?this.config.subtitle:"ar"===this.config.language?"ÿßŸÑÿ±ÿØ ŸÅŸàÿ±Ÿä":"We reply instantly"}async handleSuggestionClick(n,a){this.log("Suggestion clicked:",n,a),this.showingWelcome=!1;try{await fetch(`${this.config.apiEndpoint}/widget/suggestions/${n}/track-click/`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.config.apiKey}`},body:JSON.stringify({session_id:this.getSessionId(),page_url:e.location.href,page_title:t.title})})}catch(e){this.log("Error tracking suggestion click:",e)}this.elements.input.value=a,await this.sendMessage()}async createConversation(){try{const n=this.getSessionId(),a=this.getVisitorId(),i=await fetch(`${this.config.apiEndpoint}/widget/conversations/`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.config.apiKey}`},body:JSON.stringify({bot_id:this.config.botId,external_ref:n,visitor_id:a,metadata:{user_agent:navigator.userAgent,page_url:e.location.href,referrer:t.referrer,screen_resolution:`${e.screen.width}x${e.screen.height}`,timestamp:(new Date).toISOString()}})});if(!i.ok){const e=await i.json().catch(()=>({}));throw new Error(`Failed to create conversation: ${i.status} ${JSON.stringify(e)}`)}const o=await i.json();return this.conversationId=o.id,this.log("Conversation created:",this.conversationId),sessionStorage.setItem("tharwah_conversation_id",this.conversationId),sessionStorage.setItem("tharwah_conversation_created",Date.now().toString()),o}catch(e){throw this.log("Error creating conversation:",e),e}}getSessionId(){let e=sessionStorage.getItem("tharwah_session_id");return e||(e="session_"+Date.now()+"_"+Math.random().toString(36).substr(2,9),sessionStorage.setItem("tharwah_session_id",e),this.log("Generated new session ID:",e)),e}getVisitorId(){if(e.tracker&&"function"==typeof e.tracker.getVisitorId){const t=e.tracker.getVisitorId();if(t)return this.log("Got visitor ID from tracker:",t),t}const t="_ut_visitor";let n=null;try{const e=localStorage.getItem(t);e&&(n=JSON.parse(e))}catch(e){this.log("Error parsing tracker storage:",e)}if(n&&n.id)return this.log("Got visitor ID from tracker storage:",n.id),n.id;const a="vis_"+Date.now()+"_"+Math.random().toString(36).substr(2,9);return localStorage.setItem(t,JSON.stringify({id:a,firstSeen:Date.now(),visits:1})),this.log("Generated new visitor ID:",a),a}disableInput(){this.isWaitingForResponse=!0,this.elements.input.placeholder=this.t("waitingPlaceholder")||"Waiting for response...",this.elements.send.innerHTML='\n        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n          <rect x="6" y="6" width="12" height="12"></rect>\n        </svg>\n      ',this.elements.send.setAttribute("aria-label","Stop generation"),this.elements.send.classList.add("stop-generation"),this.log("Input state changed - waiting for response (stop button active)")}enableInput(){this.isWaitingForResponse=!1,this.elements.input.disabled=!1,this.elements.send.disabled=!1,this.elements.input.placeholder=this.t("inputPlaceholder"),this.elements.send.innerHTML='\n        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n          <path d="M14.536 21.686a.5.5 0 0 0 .937-.024l6.5-19a.496.496 0 0 0-.635-.635l-19 6.5a.5.5 0 0 0-.024.937l7.93 3.18a2 2 0 0 1 1.112 1.11z"></path>\n          <path d="m21.854 2.147-10.94 10.939"></path>\n        </svg>\n      ',this.elements.send.setAttribute("aria-label","Send message"),this.elements.send.classList.remove("stop-generation"),this.elements.send.style.opacity="1",this.elements.send.style.cursor="pointer",this.elements.input.focus(),this.log("Input enabled - ready for new message")}stopGeneration(){if(this.abortController){if(this.abortController.abort(),this.abortController=null,this.log("Generation stopped by user"),this.isDisplaying=!1,this.textQueue&&(this.textQueue.length=0),this.currentStreamingMessage){const e=this.currentStreamingMessage.querySelector(".tharwah-chat-message-content");if(e){const n=this.currentStreamingMessage.id,a=e.textContent||"";this.updateStreamingMessage(n,a,!0);const i=t.createElement("span");i.style.fontSize="11px",i.style.color="#6b7280",i.style.marginLeft="8px",i.style.fontStyle="italic",i.textContent="(Stopped)",e.appendChild(i)}this.currentStreamingMessage=null}this.enableInput()}}async sendMessage(){if(this.isWaitingForResponse)return void this.stopGeneration();const e=this.elements.input.value.trim();e&&(this.elements.input.value="",this.addMessage(e,"user"),this.disableInput(),this.trackEvent("chat_message_sent",{message_length:e.length}),this.abortController=new AbortController,this.config.enableStreaming?await this.getResponseStreaming(e):(this.showTyping(),await this.getResponse(e)),this.isWaitingForResponse&&this.enableInput())}async getResponse(e){try{if(this.conversationId||(this.log("No conversation ID, creating new conversation..."),await this.createConversation()),!this.config.apiKey)throw new Error("API key is not configured.");this.log("Sending message to backend:",e);const t=await fetch(`${this.config.apiEndpoint}/widget/conversations/${this.conversationId}/send-agent/`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.config.apiKey}`},body:JSON.stringify({content:e})});if(!t.ok){const e=await t.json().catch(()=>({}));throw new Error(`API Error ${t.status}: ${JSON.stringify(e)}`)}const n=await t.json();this.log("Received response from backend:",n),this.hideTyping();const a=n.assistant_message.content,i=n.assistant_message.id;this.addMessage(a,"bot",i);this.elements.messages.querySelectorAll(".tharwah-chat-message.bot").forEach(e=>e.classList.remove("last-message"));const o=this.elements.messages.querySelector(`[data-message-id="${i}"]`);o&&o.classList.add("last-message"),this.showFeedbackButton(),this.playNotificationSound();const s=n.composed_response?.ui_elements?.products||n.composed_response?.products||[];s.length>0&&(this.log("Showing products:",s.length),this.showProducts(s));const r=n.composed_response?.ui_elements?.quick_replies||n.composed_response?.quick_replies||[];r.length>0&&(this.log("Showing quick replies:",r.length),this.showQuickReplies(r)),this.trackEvent("chat_response_received",{agent:n.routing_info?.selected_agent?.name,agent_type:n.routing_info?.selected_agent?.type,had_products:s.length>0,had_quick_replies:r.length>0})}catch(e){this.hideTyping();let t=this.t("errorGeneric");e.message.includes("API key")&&(t=this.t("errorConfig")),this.addMessage(t,"bot"),this.log("Error getting response:",e),this.trackEvent("chat_error",{error:e.message})}}async getResponseStreaming(e){try{if(this.conversationId||(this.log("No conversation ID, creating new conversation..."),await this.createConversation()),!this.config.apiKey)throw new Error("API key is not configured.");this.log("Sending streaming message to backend:",e);const n="stream-msg-"+Date.now();this.currentStreamingMessage=this.createEmptyBotMessage(n);const a=await fetch(`${this.config.apiEndpoint}/widget/conversations/${this.conversationId}/send-agent-stream/`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.config.apiKey}`},body:JSON.stringify({content:e}),signal:this.abortController.signal});if(!a.ok){const e=await a.json().catch(()=>({}));throw new Error(`API Error ${a.status}: ${JSON.stringify(e)}`)}const i=a.body.getReader(),o=new TextDecoder;let s="",r="";this.textQueue=[],this.isDisplaying=!1;let l=[],d=[],h=[],c=null;const g=async()=>{if(!this.isDisplaying){for(this.isDisplaying=!0;this.textQueue.length>0;){const e=this.textQueue.shift();for(let t=0;t<e.length&&this.isWaitingForResponse&&this.isDisplaying;t++)r+=e[t],this.updateStreamingMessage(n,r,!1)," "!==e[t]&&await new Promise(e=>setTimeout(e,15))}this.isDisplaying=!1,r.length>0&&this.updateStreamingMessage(n,r,!0)}};for(;;){const{done:e,value:a}=await i.read();if(e)break;s+=o.decode(a,{stream:!0});const p=s.split("\n\n");s=p.pop();for(const e of p){const a=e.split("data:").filter(e=>e.trim());for(const e of a)try{let a=e.trim();const i=a.lastIndexOf("}");-1!==i&&(a=a.substring(0,i+1));const o=JSON.parse(a),s=o.type;if(this.log("Stream event:",s,o),"routing"===s)c=o.routing_info,this.log("Routing to agent:",c.selected_agent.name);else if("text"===s)this.textQueue.push(o.content),g();else if("tool_complete"===s)this.hideToolIndicator();else if("products"===s)l=o.products;else if("quick_replies"===s)d=o.quick_replies;else if("b2b_services"===s)h=o.b2b_services;else if("done"===s){for(this.log("Streaming complete. Message ID:",o.message_id);this.textQueue.length>0||this.isDisplaying;)await new Promise(e=>setTimeout(e,50));this.updateStreamingMessage(n,r,!0);const e=t.getElementById(n);if(e&&o.message_id){e.id="msg-"+o.message_id,e.setAttribute("data-message-id",o.message_id);const t=e.querySelector(".tharwah-feedback-buttons");t&&t.setAttribute("data-message-id",o.message_id),this.log("Updated streaming message ID from",n,"to",o.message_id)}this.hideToolIndicator();this.elements.messages.querySelectorAll(".tharwah-chat-message.bot").forEach(e=>e.classList.remove("last-message"));const a=t.getElementById("msg-"+o.message_id);a&&a.classList.add("last-message"),this.showFeedbackButton(),this.playNotificationSound(),l.length>0&&this.showProducts(l),d.length>0&&this.showQuickReplies(d),h.length>0&&this.showB2BServiceCards(h),this.trackEvent("chat_response_received_streaming",{agent:c?.selected_agent?.name,agent_type:c?.selected_agent?.type,had_products:l.length>0,had_quick_replies:d.length>0,had_b2b_services:h.length>0,streaming:!0})}else if("error"===s)throw new Error(o.error)}catch(e){}}}this.currentStreamingMessage=null,this.hideToolIndicator()}catch(e){if(this.hideToolIndicator(),"AbortError"===e.name)return void this.log("Streaming request aborted");this.currentStreamingMessage&&(this.currentStreamingMessage.remove(),this.currentStreamingMessage=null);let t=this.t("errorGeneric");e.message.includes("API key")&&(t=this.t("errorConfig")),this.addMessage(t,"bot"),this.log("Error getting streaming response:",e),this.trackEvent("chat_error_streaming",{error:e.message})}}createEmptyBotMessage(e){const n=t.createElement("div");return n.className="tharwah-chat-message bot",n.id=e,n.innerHTML=`\n        <div class="tharwah-chat-message-content" id="tharwah-chat-message-content-${e}">\n          <span class="streaming-cursor" id="tharwah-chat-streaming-cursor-${e}">‚ñã</span>\n        </div>\n      `,this.elements.messages.appendChild(n),this.scrollToBottom(),n}updateStreamingMessage(e,n,a=!1){const i=t.getElementById(e);if(i){const o=i.querySelector(".tharwah-chat-message-content");if(o){if(this.isArabicText(n)&&(o.style.direction="rtl",o.style.textAlign="right"),a||!this.isWaitingForResponse){o.innerHTML=this.formatMessage(n);let a=i.querySelector(".tharwah-feedback-buttons");if(!a){a=t.createElement("div"),a.className="tharwah-feedback-buttons",a.setAttribute("data-message-id",e),a.innerHTML='\n                <button class="tharwah-feedback-btn thumbs-up" id="tharwah-chat-feedback-thumbs-up-streaming" data-feedback="positive" title="Thumbs up">\n                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">\n                    <path d="M9 10L9.74 9.877C9.7579 9.9844 9.7521 10.0945 9.7231 10.1995C9.6942 10.3045 9.6427 10.4019 9.5723 10.485C9.5018 10.5681 9.4142 10.6348 9.3153 10.6806C9.2165 10.7263 9.1089 10.75 9 10.75V10ZM20 10V9.25C20.1989 9.25 20.3897 9.329 20.5303 9.4697C20.671 9.6103 20.75 9.8011 20.75 10H20ZM18 20.75H6.64V19.25H18V20.75ZM5.44 9.25H9V10.75H5.44V9.25ZM8.26 10.123L7.454 5.288L8.934 5.041L9.74 9.877L8.26 10.123ZM9.18 3.25H9.394V4.75H9.181L9.18 3.25ZM12.515 4.92L15.03 8.693L13.782 9.525L11.267 5.752L12.515 4.92ZM16.07 9.25H20V10.75H16.07V9.25ZM20.75 10V18H19.25V10H20.75ZM3.943 18.54L2.743 12.54L4.213 12.245L5.413 18.245L3.943 18.54ZM15.03 8.693C15.1441 8.8643 15.2987 9.0037 15.4802 9.1009C15.6616 9.1981 15.8642 9.2489 16.07 9.249V10.749C15.15 10.749 14.292 10.29 13.782 9.525L15.03 8.693ZM7.454 5.288C7.4122 5.0373 7.4255 4.7795 7.4929 4.5344C7.5604 4.2894 7.6804 4.062 7.8447 3.868C8.009 3.6741 8.2135 3.5182 8.4441 3.4113C8.6747 3.3044 8.9258 3.25 9.18 3.25V4.749C9.1438 4.7491 9.108 4.7571 9.0751 4.7724C9.0422 4.7877 9.0131 4.8099 8.9897 4.8376C8.9663 4.8653 8.9492 4.8977 8.9396 4.9327C8.93 4.9676 8.9281 5.0052 8.934 5.041L7.454 5.288ZM5.44 10.749C5.2551 10.749 5.0724 10.79 4.9052 10.8691C4.738 10.9481 4.5905 11.0634 4.4732 11.2064C4.3559 11.3494 4.2718 11.5166 4.227 11.6961C4.1822 11.8755 4.1778 12.0626 4.214 12.244L2.743 12.539C2.6633 12.14 2.673 11.7273 2.7716 11.3326C2.8702 10.9378 3.0552 10.5699 3.3132 10.2553C3.5712 9.9407 3.8958 9.6872 4.2635 9.5132C4.6313 9.3392 5.0331 9.2489 5.44 9.249V10.749ZM6.64 20.75C6.0043 20.7501 5.3882 20.529 4.8965 20.1261C4.4048 19.7232 4.0678 19.1633 3.943 18.54L5.413 18.245C5.4695 18.5288 5.6227 18.7832 5.8464 18.9666C6.0702 19.1501 6.3506 19.2502 6.64 19.25V20.75ZM9.394 3.25C10.0113 3.25 10.6191 3.4015 11.1634 3.6928C11.7077 3.9841 12.1716 4.4053 12.514 4.919L11.267 5.751C11.0615 5.4427 10.7829 5.1899 10.4562 5.0151C10.1294 4.8403 9.7646 4.7499 9.394 4.75V3.25ZM18 19.25C18.69 19.25 19.25 18.69 19.25 18H20.75C20.75 18.7293 20.4603 19.4288 19.9445 19.9445C19.4288 20.4603 18.7293 20.75 18 20.75V19.25Z" fill="#AAAAAA"/>\n                    <path d="M16 10V20" stroke="#AAAAAA" stroke-width="1.5"/>\n                  </svg>\n                </button>\n                <button class="tharwah-feedback-btn thumbs-down" id="tharwah-chat-feedback-thumbs-down-streaming" data-feedback="negative" title="Thumbs down">\n                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">\n                    <path d="M15 14L14.26 14.123C14.2421 14.0156 14.2479 13.9055 14.2769 13.8005C14.3058 13.6955 14.3573 13.5981 14.4277 13.515C14.4982 13.432 14.5858 13.3652 14.6847 13.3194C14.7835 13.2737 14.8911 13.25 15 13.25V14ZM4 14V14.75C3.80109 14.75 3.61032 14.671 3.46967 14.5303C3.32902 14.3897 3.25 14.1989 3.25 14H4ZM6 3.25H17.36V4.75H6V3.25ZM18.56 14.75H15V13.25H18.56V14.75ZM15.74 13.877L16.546 18.712L15.066 18.959L14.26 14.123L15.74 13.877ZM14.82 20.75H14.606V19.25H14.819L14.82 20.75ZM11.485 19.08L8.97 15.307L10.218 14.475L12.733 18.248L11.485 19.08ZM7.93 14.75H4V13.25H7.93V14.75ZM3.25 14V6H4.75V14H3.25ZM20.057 5.46L21.257 11.46L19.787 11.755L18.587 5.755L20.057 5.46ZM8.97 15.307C8.8559 15.1357 8.70127 14.9963 8.51985 14.8991C8.33842 14.8019 8.13581 14.7511 7.93 14.751V13.251C8.85 13.251 9.708 13.71 10.218 14.475L8.97 15.307ZM16.546 18.712C16.5878 18.9627 16.5745 19.2205 16.5071 19.4656C16.4396 19.7106 16.3196 19.938 16.1553 20.132C15.991 20.3259 15.7865 20.4818 15.5559 20.5887C15.3253 20.6956 15.0742 20.75 14.82 20.75V19.251C14.8562 19.2509 14.892 19.2429 14.9249 19.2276C14.9578 19.2123 14.9869 19.1901 15.0103 19.1624C15.0337 19.1347 15.0508 19.1023 15.0604 19.0673C15.07 19.0324 15.0719 18.9948 15.066 18.959L16.546 18.712ZM18.56 13.251C18.7449 13.251 18.9276 13.21 19.0948 13.1309C19.262 13.0519 19.4095 12.9366 19.5268 12.7936C19.6441 12.6506 19.7282 12.4834 19.773 12.3039C19.8178 12.1245 19.8222 11.9374 19.786 11.756L21.257 11.461C21.3367 11.86 21.327 12.2727 21.2284 12.6674C21.1298 13.0622 20.9448 13.4301 20.6868 13.7447C20.4288 14.0593 20.1042 14.3128 19.7365 14.4868C19.3687 14.6608 18.9669 14.7511 18.56 14.751V13.251ZM17.36 3.25C17.9957 3.24988 18.6118 3.471 19.1035 3.87392C19.5952 4.27684 19.9322 4.83667 20.057 5.46L18.587 5.755C18.5305 5.47122 18.3773 5.21682 18.1536 5.03336C17.9298 4.84991 17.6494 4.74976 17.36 4.75V3.25ZM14.606 20.75C13.9887 20.75 13.3809 20.5985 12.8366 20.3072C12.2923 20.0159 11.8284 19.5947 11.486 19.081L12.733 18.249C12.9385 18.5573 13.2171 18.8101 13.5438 18.9849C13.8706 19.1597 14.2354 19.2501 14.606 19.25V20.75ZM6 4.75C5.31 4.75 4.75 5.31 4.75 6H3.25C3.25 5.27065 3.53973 4.57118 4.05546 4.05546C4.57118 3.53973 5.27065 3.25 6 3.25V4.75Z" fill="#AAAAAA"/>\n                    <path d="M8 14V4" stroke="#AAAAAA" stroke-width="1.5"/>\n                  </svg>\n                </button>\n              ',i.appendChild(a);const n=a.querySelector(".thumbs-up"),o=a.querySelector(".thumbs-down");n?.addEventListener("click",()=>{const e=a.getAttribute("data-message-id");this.submitMessageFeedback(e,"positive",n,o)}),o?.addEventListener("click",()=>{const e=a.getAttribute("data-message-id");this.submitMessageFeedback(e,"negative",n,o)})}}else o.innerHTML=this.formatMessage(n)+'<span class="streaming-cursor">‚ñã</span>';this.scrollToBottom()}}}showToolIndicator(e){this.hideToolIndicator();const n=t.createElement("div");n.className="tharwah-chat-message bot tool-indicator",n.id="tool-indicator",n.innerHTML=`\n        <div class="tharwah-chat-message-content" id="tharwah-chat-tool-indicator-content" style="background: #eff6ff; border: 1px solid #dbeafe;">\n          <div style="display: flex; align-items: center; gap: 8px;" id="tharwah-chat-tool-indicator-inner">\n            <div class="spinner-small" id="tharwah-chat-tool-spinner"></div>\n            <span style="font-size: 12px; color: #1d4ed8;" id="tharwah-chat-tool-text">${this.t("toolUsing")} ${e}...</span>\n          </div>\n        </div>\n      `,this.elements.messages.appendChild(n),this.scrollToBottom()}updateToolIndicator(e,n){const a=t.getElementById("tool-indicator");if(a){const t=a.querySelector(".tharwah-chat-message-content");t&&"executing"===n&&(t.innerHTML=`\n              <div style="display: flex; align-items: center; gap: 8px;" id="tharwah-chat-tool-executing-inner">\n                <div class="spinner-small" id="tharwah-chat-tool-executing-spinner"></div>\n                <span style="font-size: 12px; color: #1d4ed8;" id="tharwah-chat-tool-executing-text">‚öôÔ∏è ${this.t("toolExecuting")} ${e}...</span>\n              </div>\n            `)}}hideToolIndicator(){const e=t.getElementById("tool-indicator");e&&e.remove()}showProducts(e){const n=this.config.apiEndpoint.replace(/\/api\/?$/,""),a=e.map(e=>{const t=e.name||"",a=e.image_url||e.image||null,i=a?`${n}${a}`:null,o=e.image_alt||t,s=e.product_link||e.enroll_link||e.external_link||e.link||null,r=e.metadata?.price||e.price||null,l=e.metadata?.regular_price||0,d=e.metadata?.sale_price||0,h=e.metadata?.has_discount||!1,c=e.metadata?.discount_percentage||0,g=(e.metadata,e.metadata?.currency||e.currency||"SAR"),p=e.metadata?.rating||e.rating||null,u=e.metadata?.enrollments||e.enrollments||null,m=e.metadata?.brochure_url||null,b=e.metadata?.audio_url||e.metadata?.audio_url_en||e.metadata?.audio_url_ar||null,f=b?`${n}${b}`:null,w=h&&d?d:r,x=w?`${g} ${w.toLocaleString()}`:"",y=h&&l?`${g} ${l.toLocaleString()}`:"";let v=0;return v=r<=5e3?Math.round(r/4*100)/100:Math.round(r/12*100)/100,`\n          <div style="\n            background: white;\n            border: 1px solid #e5e7eb;\n            border-radius: 12px;\n            overflow: hidden;\n            box-shadow: 0 1px 3px rgba(0,0,0,0.1);\n            transition: all 0.2s;\n            flex-shrink: 0;\n            width: 180px;\n          " onmouseover="this.style.boxShadow='0 4px 6px rgba(0,0,0,0.1)'" onmouseout="this.style.boxShadow='0 1px 3px rgba(0,0,0,0.1)'">\n            \x3c!-- Image --\x3e\n            <div style="position: relative;">\n              ${i?`<img src="${i}" alt="${this.escapeHtml(o)}" style="width: 100%; height: 96px; object-fit: cover;" onerror="this.parentElement.innerHTML='<div style=\\'width: 100%; height: 96px; background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);\\' />';" />`:'<div style="width: 100%; height: 96px; background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);"></div>'}\n              ${h&&c?`\n                <div style="\n                  position: absolute;\n                  top: 6px;\n                  right: 6px;\n                  background: #dc2626;\n                  color: white;\n                  padding: 2px 6px;\n                  border-radius: 6px;\n                  font-size: 10px;\n                  font-weight: 700;\n                  box-shadow: 0 2px 4px rgba(0,0,0,0.2);\n                ">\n                  -${c}%\n                </div>\n              `:""}\n            </div>\n            \n            \x3c!-- Content --\x3e\n            <div style="padding: 8px;">\n              \x3c!-- Title with audio button --\x3e\n              <div style="display: flex; align-items: flex-start; justify-content: space-between; gap: 6px; margin-bottom: 4px;">\n                ${s?`\n                <a href="${s}" target="_blank" rel="noopener noreferrer" style="\n                  font-size: 12px;\n                  font-weight: 600;\n                  color: #111827;\n                  margin: 0;\n                  line-height: 1.3;\n                  display: -webkit-box;\n                  -webkit-line-clamp: 2;\n                  -webkit-box-orient: vertical;\n                  overflow: hidden;\n                  height: 32px;\n                  flex: 1;\n                  text-decoration: none;\n                  transition: color 0.2s;\n                " onmouseover="this.style.color='#2563eb'" onmouseout="this.style.color='#111827'">${this.escapeHtml(t)}</a>\n                `:`\n                <h4 style="\n                  font-size: 12px;\n                  font-weight: 600;\n                  color: #111827;\n                  margin: 0;\n                  line-height: 1.3;\n                  display: -webkit-box;\n                  -webkit-line-clamp: 2;\n                  -webkit-box-orient: vertical;\n                  overflow: hidden;\n                  height: 32px;\n                  flex: 1;\n                ">${this.escapeHtml(t)}</h4>\n                `}\n                <button \n                  data-audio-url="${f||""}"\n                  style="\n                  flex-shrink: 0;\n                  padding: 4px;\n                  border-radius: 50%;\n                  background: #eff6ff;\n                  color: #2563eb;\n                  border: none;\n                  cursor: ${f?"pointer":"not-allowed"};\n                  transition: all 0.2s;\n                  display: flex;\n                  align-items: center;\n                  justify-content: center;\n                  width: 24px;\n                  height: 24px;\n                  opacity: ${f?"1":"0.5"};\n                " \n                onmouseover="if(this.dataset.audioUrl) { this.style.background='#dbeafe'; this.style.transform='scale(1.1)' }" \n                onmouseout="this.style.background='#eff6ff'; this.style.transform='scale(1)'" \n                onclick="window.tharwahChatWidget.playProductAudio(this.dataset.audioUrl, this)" \n                aria-label="Listen to description" \n                title="${f?"Listen to description":"Audio not available"}">\n                  <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n                    <path d="M11 4.702a.705.705 0 0 0-1.203-.498L6.413 7.587A1.4 1.4 0 0 1 5.416 8H3a1 1 0 0 0-1 1v6a1 1 0 0 0 1 1h2.416a1.4 1.4 0 0 1 .997.413l3.383 3.384A.705.705 0 0 0 11 19.298z"></path>\n                    <path d="M16 9a5 5 0 0 1 0 6"></path>\n                    <path d="M19.364 18.364a9 9 0 0 0 0-12.728"></path>\n                  </svg>\n                </button>\n              </div>\n              \n              \x3c!-- Rating --\x3e\n              ${p?`\n                <div style="display: flex; align-items: center; gap: 4px; margin-bottom: 6px;">\n                  <svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 24 24" fill="#facc15" stroke="#facc15" stroke-width="2">\n                    <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>\n                  </svg>\n                  <span style="font-size: 10px; font-weight: 500; color: #111827;">${p}</span>\n                  ${u?`<span style="font-size: 10px; color: #6b7280;">(${u>1e3?Math.floor(u/1e3)+"k+":u})</span>`:""}\n                </div>\n              `:""}\n              \n              \x3c!-- Pricing --\x3e\n              ${x?`\n                <div style="border-top: 1px solid #e5e7eb; padding-top: 4px; margin-bottom: 8px;">\n                  ${h&&y?`\n                    <div style="font-size: 9px; color: #9ca3af; text-decoration: line-through; line-height: 1; margin-bottom: 2px;">${this.escapeHtml(y)}</div>\n                  `:""}\n                  <div style="font-size: 14px; font-weight: 700; color: ${h?"#dc2626":"#2563eb"}; line-height: 1.2; margin-bottom: 2px;">${this.escapeHtml(x)}</div>\n                  ${v?`<div style="font-size: 9px; color: #16a34a; font-weight: 500; margin-top: 2px; line-height: 1;">${g} ${v}/mo</div>`:""}\n                </div>\n              `:""}\n              \n              \x3c!-- Enroll Button --\x3e\n              ${s?`\n                <button\n                  id="tharwah-chat-enroll-now-${e.wp_id||e.id}"\n                  data-product='${JSON.stringify(e).replace(/'/g,"&apos;")}'\n                  onclick="window.tharwahChatWidget.showEnrollmentForm(JSON.parse(this.dataset.product))"\n                  style="\n                    display: inline-flex;\n                    align-items: center;\n                    justify-content: center;\n                    width: 100%;\n                    padding: 6px 16px;\n                    background: #2563eb;\n                    color: white;\n                    text-decoration: none;\n                    border: none;\n                    border-radius: 6px;\n                    font-size: 11px;\n                    font-weight: 600;\n                    transition: background 0.2s;\n                    box-shadow: 0 1px 2px rgba(0,0,0,0.05);\n                    line-height: 1.5;\n                    cursor: pointer;\n                  " \n                  onmouseover="this.style.background='#1d4ed8'" \n                  onmouseout="this.style.background='#2563eb'">\n                    ${this.t("enrollNow")}\n                </button>\n              `:""}\n              \n              \x3c!-- Download Brochure Button --\x3e\n              ${m?`\n                <a id="tharwah-chat-download-brochure-${e.wp_id||e.id}" href="${m}" target="_blank" rel="noopener noreferrer" download style="\n                  display: inline-flex;\n                  align-items: center;\n                  justify-content: center;\n                  gap: 4px;\n                  width: 100%;\n                  padding: 6px 16px;\n                  margin-top: 6px;\n                  background: white;\n                  color: #2563eb;\n                  text-decoration: none;\n                  border: 1px solid #2563eb;\n                  border-radius: 6px;\n                  font-size: 11px;\n                  font-weight: 600;\n                  transition: all 0.2s;\n                  box-shadow: 0 1px 2px rgba(0,0,0,0.05);\n                  line-height: 1.5;\n                " onmouseover="this.style.background='#eff6ff'; this.style.borderColor='#1d4ed8'; this.style.color='#1d4ed8'" onmouseout="this.style.background='white'; this.style.borderColor='#2563eb'; this.style.color='#2563eb'">\n                  <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>\n                    <polyline points="7 10 12 15 17 10"></polyline>\n                    <line x1="12" y1="15" x2="12" y2="3"></line>\n                  </svg>\n                  ${this.t("downloadBrochure")}\n                </a>\n              `:""}\n            </div>\n          </div>\n        `}).join(""),i=t.createElement("div");i.className="tharwah-chat-message bot",i.innerHTML=`\n        <div class="tharwah-chat-message-content" id="tharwah-chat-suggestions-content" style="max-width: 100%; padding: 0; background: transparent; box-shadow: none;">\n          <div id="tharwah-chat-suggestions-container" style="\n            display: flex;\n            gap: 12px;\n            overflow-x: auto;\n            padding: 8px 4px;\n            scrollbar-width: thin;\n            scrollbar-color: #cbd5e1 #f1f5f9;\n          ">\n            ${a}\n          </div>\n        </div>\n      `,this.elements.messages.appendChild(i)}playProductAudio(e,t){if(e&&"null"!==e&&""!==e){if(this.currentAudioButton===t&&this.currentAudio&&!this.currentAudio.paused)return this.currentAudio.pause(),this.currentAudio.currentTime=0,t.innerHTML='\n          <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n            <path d="M11 4.702a.705.705 0 0 0-1.203-.498L6.413 7.587A1.4 1.4 0 0 1 5.416 8H3a1 1 0 0 0-1 1v6a1 1 0 0 0 1 1h2.416a1.4 1.4 0 0 1 .997.413l3.383 3.384A.705.705 0 0 0 11 19.298z"></path>\n            <path d="M16 9a5 5 0 0 1 0 6"></path>\n            <path d="M19.364 18.364a9 9 0 0 0 0-12.728"></path>\n          </svg>\n        ',this.currentAudio=null,void(this.currentAudioButton=null);this.currentAudio&&(this.currentAudio.pause(),this.currentAudio.currentTime=0,this.currentAudioButton&&(this.currentAudioButton.innerHTML='\n            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n              <path d="M11 4.702a.705.705 0 0 0-1.203-.498L6.413 7.587A1.4 1.4 0 0 1 5.416 8H3a1 1 0 0 0-1 1v6a1 1 0 0 0 1 1h2.416a1.4 1.4 0 0 1 .997.413l3.383 3.384A.705.705 0 0 0 11 19.298z"></path>\n              <path d="M16 9a5 5 0 0 1 0 6"></path>\n              <path d="M19.364 18.364a9 9 0 0 0 0-12.728"></path>\n            </svg>\n          ')),this.currentAudio=new Audio(e),this.currentAudioButton=t,t.innerHTML='\n        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n          <rect x="6" y="4" width="4" height="16"></rect>\n          <rect x="14" y="4" width="4" height="16"></rect>\n        </svg>\n      ',this.currentAudio.play().catch(e=>{this.config.debug&&console.error("[TharwahChat] Audio playback error:",e),alert("Failed to play audio. Please try again."),t.innerHTML='\n          <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n            <path d="M11 4.702a.705.705 0 0 0-1.203-.498L6.413 7.587A1.4 1.4 0 0 1 5.416 8H3a1 1 0 0 0-1 1v6a1 1 0 0 0 1 1h2.416a1.4 1.4 0 0 1 .997.413l3.383 3.384A.705.705 0 0 0 11 19.298z"></path>\n            <path d="M16 9a5 5 0 0 1 0 6"></path>\n            <path d="M19.364 18.364a9 9 0 0 0 0-12.728"></path>\n          </svg>\n        ',this.currentAudio=null,this.currentAudioButton=null}),this.currentAudio.addEventListener("ended",()=>{t.innerHTML='\n          <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n            <path d="M11 4.702a.705.705 0 0 0-1.203-.498L6.413 7.587A1.4 1.4 0 0 1 5.416 8H3a1 1 0 0 0-1 1v6a1 1 0 0 0 1 1h2.416a1.4 1.4 0 0 1 .997.413l3.383 3.384A.705.705 0 0 0 11 19.298z"></path>\n            <path d="M16 9a5 5 0 0 1 0 6"></path>\n            <path d="M19.364 18.364a9 9 0 0 0 0-12.728"></path>\n          </svg>\n        ',this.currentAudio=null,this.currentAudioButton=null})}else alert(this.t("audioFeature"))}showQuickReplies(e){const n=[{bg:"#dbeafe",hover:"#bfdbfe",text:"#1d4ed8",border:"#93c5fd"},{bg:"#dcfce7",hover:"#bbf7d0",text:"#15803d",border:"#86efac"},{bg:"#f3e8ff",hover:"#e9d5ff",text:"#7e22ce",border:"#d8b4fe"},{bg:"#fef3c7",hover:"#fde68a",text:"#a16207",border:"#fcd34d"}],a=e.map((e,t)=>{const a=e.title||e.text||"",i=e.reply_text||e.text||a,o=e.icon||"",s=e.id||"",r=n[t%n.length],l=o||'<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n          <path d="M9.937 15.5A2 2 0 0 0 8.5 14.063l-6.135-1.582a.5.5 0 0 1 0-.962L8.5 9.936A2 2 0 0 0 9.937 8.5l1.582-6.135a.5.5 0 0 1 .963 0L14.063 8.5A2 2 0 0 0 15.5 9.937l6.135 1.581a.5.5 0 0 1 0 .964L15.5 14.063a2 2 0 0 0-1.437 1.437l-1.582 6.135a.5.5 0 0 1-.963 0z"></path>\n        </svg>';return`<button\n          id="tharwah-chat-quick-reply-${s||t}"\n          onclick="window.tharwahChatWidget.handleQuickReply('${this.escapeHtml(i).replace(/'/g,"\\'")}', '${s}')"\n          style="\n            display: inline-flex;\n            align-items: center;\n            justify-content: center;\n            padding: 4px 10px;\n            height: 28px;\n            background: ${r.bg};\n            color: ${r.text};\n            border: 1px solid ${r.border};\n            border-radius: 6px;\n            cursor: pointer;\n            font-size: 11px;\n            font-weight: 500;\n            transition: all 0.2s;\n            box-shadow: 0 1px 2px rgba(0,0,0,0.05);\n            gap: 4px;\n          "\n          onmouseover="this.style.background='${r.hover}'; this.style.transform='scale(1.05)';"\n          onmouseout="this.style.background='${r.bg}'; this.style.transform='scale(1)';"\n          onmousedown="this.style.transform='scale(0.95)';"\n          onmouseup="this.style.transform='scale(1.05)';"\n        >\n          <span style="display: flex; align-items: center;">${"string"==typeof o&&o.length<=2?o:l}</span>\n          <span>${this.escapeHtml(a)}</span>\n        </button>`}).join(""),i=t.createElement("div");i.className="tharwah-chat-message bot",i.innerHTML=`\n        <div class="tharwah-chat-message-content" id="tharwah-chat-similar-products-content" style="max-width: 100%; padding: 0; background: transparent; box-shadow: none;">\n          <div id="tharwah-chat-similar-products-container" style="border-top: 1px solid #e5e7eb; background: #f9fafb; padding: 6px 8px; border-radius: 6px; margin-top: 6px;">\n            \x3c!-- Header with sparkles icon --\x3e\n            <div id="tharwah-chat-similar-products-header" style="display: flex; align-items: center; gap: 4px; margin-bottom: 6px; padding: 0 2px;">\n              <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#2563eb" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n                <path d="M9.937 15.5A2 2 0 0 0 8.5 14.063l-6.135-1.582a.5.5 0 0 1 0-.962L8.5 9.936A2 2 0 0 0 9.937 8.5l1.582-6.135a.5.5 0 0 1 .963 0L14.063 8.5A2 2 0 0 0 15.5 9.937l6.135 1.581a.5.5 0 0 1 0 .964L15.5 14.063a2 2 0 0 0-1.437 1.437l-1.582 6.135a.5.5 0 0 1-.963 0z"></path>\n                <path d="M20 3v4"></path>\n                <path d="M22 5h-4"></path>\n                <path d="M4 17v2"></path>\n                <path d="M5 18H3"></path>\n              </svg>\n              <p style="font-size: 11px; font-weight: 500; color: #374151; margin: 0;">${this.t("quickSuggestionsHeader")}</p>\n            </div>\n            \n            \x3c!-- Buttons --\x3e\n            <div style="display: flex; flex-wrap: wrap; gap: 4px; margin-bottom: 4px;">\n              ${a}\n            </div>\n            \n            \x3c!-- Footer text --\x3e\n            <div style="padding: 0 2px;">\n              <p style="font-size: 9px; color: #6b7280; font-style: italic; margin: 0;">${this.t("quickSuggestionsFooter")}</p>\n            </div>\n          </div>\n        </div>\n      `,this.elements.messages.appendChild(i)}handleQuickReply(e,t){this.log("Quick reply clicked:",e,t),this.trackEvent("chat_quick_reply_clicked",{reply_id:t,reply_text:e}),this.elements.input.value=e,this.sendMessage()}injectStyles(){const e=`\n        /* Import Tajawal font from Google Fonts */\n        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@200;300;400;500;700;800;900&display=swap');\n\n        /* Base styles */\n        .tharwah-chat-widget * {\n          box-sizing: border-box;\n          margin: 0;\n          padding: 0;\n          font-family: 'Tajawal', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;\n        }\n\n        /* Chat button */\n        .tharwah-chat-button {\n          position: fixed;\n          ${this.config.position.includes("right")?"right: 24px;":"left: 24px;"}\n          bottom: 24px;\n          width: 60px;\n          height: 60px;\n          border-radius: 50%;\n          background: #2563eb;\n          color: white;\n          border: none;\n          cursor: pointer;\n          box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);\n          transition: all 0.3s ease;\n          z-index: 999999;\n          display: flex;\n          align-items: center;\n          justify-content: center;\n          animation: bounce-subtle 2s ease-in-out infinite;\n        }\n\n        @keyframes bounce-subtle {\n          0%, 100% {\n            transform: translateY(0);\n          }\n          50% {\n            transform: translateY(-8px);\n          }\n        }\n\n        .tharwah-chat-button:hover {\n          background: #1d4ed8;\n          transform: scale(1.1);\n          box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.35);\n          animation: none;\n        }\n\n        .tharwah-chat-button.open {\n          background: #1d4ed8;\n          animation: none;\n        }\n\n        .tharwah-chat-button svg {\n          width: 28px;\n          height: 28px;\n        }\n\n        /* Notification badge */\n        .tharwah-notification-badge {\n          position: absolute;\n          top: -4px;\n          right: -4px;\n          width: 12px;\n          height: 12px;\n        }\n\n        .tharwah-notification-ping {\n          position: absolute;\n          display: inline-flex;\n          height: 100%;\n          width: 100%;\n          border-radius: 50%;\n          background-color: #f87171;\n          opacity: 0.75;\n          animation: ping 1s cubic-bezier(0, 0, 0.2, 1) infinite;\n        }\n\n        @keyframes ping {\n          75%, 100% {\n            transform: scale(2);\n            opacity: 0;\n          }\n        }\n\n        .tharwah-notification-dot {\n          position: relative;\n          display: inline-flex;\n          height: 12px;\n          width: 12px;\n          border-radius: 50%;\n          background-color: #ef4444;\n        }\n\n        /* Chat window */\n        .tharwah-chat-window {\n          position: fixed;\n          ${this.config.position.includes("right")?"right: 20px;":"left: 20px;"}\n          bottom: 90px;\n          width: 380px;\n          height: 600px;\n          background: white;\n          border-radius: 12px;\n          box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);\n          display: none;\n          flex-direction: column;\n          overflow: hidden;\n          z-index: 999998;\n          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;\n          /* iOS touch handling */\n          -webkit-overflow-scrolling: touch;\n          -webkit-touch-callout: none;\n          -webkit-user-select: none;\n          user-select: none;\n        }\n\n        .tharwah-chat-window.active {\n          display: flex;\n          animation: slideInUp 0.3s ease-out;\n        }\n\n        @keyframes slideInUp {\n          from {\n            opacity: 0;\n            transform: translateY(20px);\n          }\n          to {\n            opacity: 1;\n            transform: translateY(0);\n          }\n        }\n\n        /* Header */\n        .tharwah-chat-header {\n          background: white;\n          border-bottom: 1px solid #e5e7eb;\n          padding: 12px 16px;\n          display: flex;\n          justify-content: space-between;\n          align-items: center;\n        }\n\n        .tharwah-chat-header h2 {\n          font-size: 15px;\n          font-weight: 600;\n          color: #111827;\n          margin: 0;\n        }\n\n        .tharwah-chat-close {\n          background: none;\n          border: none;\n          color: #6b7280;\n          cursor: pointer;\n          padding: 6px;\n          width: 32px;\n          height: 32px;\n          display: flex;\n          align-items: center;\n          justify-content: center;\n          border-radius: 8px;\n          transition: all 0.2s;\n        }\n\n        .tharwah-chat-close:hover {\n          background: #f3f4f6;\n          color: #374151;\n        }\n\n        /* Menu Button (3-dots) */\n        .tharwah-chat-menu {\n          background: none;\n          border: none;\n          color: #6b7280;\n          cursor: pointer;\n          padding: 6px;\n          width: 32px;\n          height: 32px;\n          display: flex;\n          align-items: center;\n          justify-content: center;\n          border-radius: 8px;\n          transition: all 0.2s;\n        }\n\n        .tharwah-chat-menu:hover {\n          background: #f3f4f6;\n          color: #374151;\n        }\n\n        /* Menu Dropdown */\n        .tharwah-chat-menu-dropdown {\n          position: absolute;\n          top: 50px;\n          right: 16px;\n          background: white;\n          border-radius: 12px;\n          box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);\n          padding: 8px;\n          min-width: 240px;\n          z-index: 1000;\n          animation: fadeIn 0.2s ease-out;\n        }\n\n        .tharwah-menu-item {\n          display: flex;\n          align-items: center;\n          gap: 12px;\n          padding: 12px 16px;\n          border-radius: 8px;\n          cursor: pointer;\n          transition: all 0.2s;\n          color: #374151;\n          font-size: 14px;\n          user-select: none;\n        }\n\n        .tharwah-menu-item:hover {\n          background: #f9fafb;\n        }\n\n        .tharwah-menu-item:active {\n          background: #f3f4f6;\n        }\n\n        .tharwah-menu-item svg {\n          flex-shrink: 0;\n          color: #6b7280;\n        }\n\n        .tharwah-menu-item span {\n          flex: 1;\n        }\n\n        /* Toggle Switch */\n        .tharwah-toggle-switch {\n          position: relative;\n          width: 44px;\n          height: 24px;\n        }\n\n        .tharwah-toggle-switch input {\n          position: absolute;\n          opacity: 0;\n          width: 0;\n          height: 0;\n          pointer-events: none;\n        }\n\n        .tharwah-toggle-slider {\n          position: absolute;\n          cursor: pointer;\n          top: 0;\n          left: 0;\n          right: 0;\n          bottom: 0;\n          background-color: #cbd5e0;\n          transition: 0.3s;\n          border-radius: 24px;\n        }\n\n        .tharwah-toggle-slider:before {\n          position: absolute;\n          content: "";\n          height: 18px;\n          width: 18px;\n          left: 3px;\n          bottom: 3px;\n          background-color: white;\n          transition: 0.3s;\n          border-radius: 50%;\n        }\n\n        .tharwah-toggle-switch input:checked + .tharwah-toggle-slider {\n          background-color: ${this.config.primaryColor};\n        }\n\n        .tharwah-toggle-switch input:checked + .tharwah-toggle-slider:before {\n          transform: translateX(20px);\n        }\n\n        /* Feedback trigger line under input */\n        .tharwah-feedback-section {\n          padding: 0px 16px;\n          background: white;\n          border-top: 1px solid #e5e7eb;\n          display: none;\n          text-align: center;\n        }\n\n        .tharwah-feedback-section.show {\n          display: block;\n        }\n\n        .tharwah-feedback-trigger {\n          background: none;\n          border: none;\n          color: #6b7280;\n          font-size: 11px;\n          cursor: pointer;\n          padding: 0;\n          transition: color 0.2s;\n          text-decoration: underline;\n        }\n\n        .tharwah-feedback-trigger:hover {\n          color: #374151;\n        }\n\n        /* Feedback dialog overlay */\n        .tharwah-feedback-overlay {\n          position: fixed;\n          top: 0;\n          left: 0;\n          right: 0;\n          bottom: 0;\n          background: rgba(0, 0, 0, 0.5);\n          display: flex;\n          align-items: center;\n          justify-content: center;\n          z-index: 1000000;\n          animation: fadeIn 0.2s ease;\n        }\n\n        @keyframes fadeIn {\n          from { opacity: 0; }\n          to { opacity: 1; }\n        }\n\n        /* Feedback dialog content */\n        .tharwah-feedback-dialog-content {\n          background: white;\n          border-radius: 16px;\n          box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);\n          max-width: 480px;\n          width: 90%;\n          max-height: 80vh;\n          overflow-y: auto;\n          animation: slideUp 0.3s ease;\n        }\n\n        @keyframes slideUp {\n          from {\n            transform: translateY(20px);\n            opacity: 0;\n          }\n          to {\n            transform: translateY(0);\n            opacity: 1;\n          }\n        }\n\n        .tharwah-feedback-header {\n          padding: 24px 24px 16px;\n          text-align: center;\n          border-bottom: 1px solid #e5e7eb;\n        }\n\n        .tharwah-feedback-header h3 {\n          font-size: 20px;\n          font-weight: 600;\n          color: #111827;\n          margin: 0 0 8px 0;\n        }\n\n        .tharwah-feedback-header p {\n          font-size: 14px;\n          color: #6b7280;\n          margin: 0;\n        }\n\n        .tharwah-feedback-body {\n          padding: 24px;\n        }\n\n        /* Star rating */\n        .tharwah-star-rating {\n          display: flex;\n          justify-content: center;\n          gap: 8px;\n          margin-bottom: 24px;\n        }\n\n        .tharwah-star {\n          background: none;\n          border: none;\n          padding: 4px;\n          cursor: pointer;\n          transition: transform 0.2s ease;\n        }\n\n        .tharwah-star:hover {\n          transform: scale(1.15);\n        }\n\n        .tharwah-star:active {\n          transform: scale(0.95);\n        }\n\n        .tharwah-star svg {\n          stroke: #d1d5db;\n          transition: all 0.2s ease;\n        }\n\n        /* Feedback form fields */\n        .tharwah-feedback-field {\n          margin-bottom: 16px;\n        }\n\n        .tharwah-feedback-field label {\n          display: block;\n          font-size: 14px;\n          font-weight: 500;\n          color: #374151;\n          margin-bottom: 6px;\n        }\n\n        .tharwah-feedback-select,\n        .tharwah-feedback-textarea {\n          width: 100%;\n          padding: 10px 12px;\n          border: 1px solid #d1d5db;\n          border-radius: 8px;\n          font-size: 14px;\n          font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;\n          transition: border-color 0.2s ease, box-shadow 0.2s ease;\n        }\n\n        .tharwah-feedback-select:focus,\n        .tharwah-feedback-textarea:focus {\n          outline: none;\n          border-color: #2563eb;\n          box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);\n        }\n\n        .tharwah-feedback-textarea {\n          resize: vertical;\n          min-height: 80px;\n        }\n\n        /* Feedback actions */\n        .tharwah-feedback-actions {\n          padding: 16px 24px 24px;\n          display: flex;\n          gap: 12px;\n          justify-content: center;\n          align-items: center;\n        }\n\n        .tharwah-feedback-btn {\n          padding: 12px 32px;\n          border-radius: 8px;\n          font-size: 14px;\n          font-weight: 600;\n          cursor: pointer;\n          border: none;\n          transition: all 0.2s ease;\n          min-width: 140px;\n          white-space: nowrap;\n        }\n\n        .tharwah-feedback-btn:disabled {\n          cursor: not-allowed;\n        }\n\n        .tharwah-feedback-btn-primary {\n          background: #2563eb !important;\n          color: white !important;\n        }\n\n        .tharwah-feedback-btn-primary:disabled {\n          background: #93c5fd !important;\n          color: white !important;\n          opacity: 1;\n        }\n\n        .tharwah-feedback-btn-primary:hover:not(:disabled) {\n          background: #1d4ed8 !important;\n          transform: translateY(-1px);\n          box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);\n        }\n\n        .tharwah-feedback-btn-secondary {\n          background: #f3f4f6;\n          color: #6b7280;\n          border: 1px solid #e5e7eb;\n        }\n\n        .tharwah-feedback-btn-secondary:hover {\n          background: #e5e7eb;\n          color: #374151;\n        }\n\n        /* Messages */\n        .tharwah-chat-messages {\n          flex: 1;\n          overflow-y: auto;\n          padding: 16px;\n          background: #f9fafb;\n        }\n\n        .tharwah-chat-message {\n          margin-bottom: 12px;\n          animation: fadeIn 0.3s;\n        }\n\n        @keyframes fadeIn {\n          from { opacity: 0; }\n          to { opacity: 1; }\n        }\n\n        .tharwah-chat-message.user {\n          text-align: ${"ar"===this.config.language?"left":"right"};\n        }\n\n        .tharwah-chat-message.bot {\n          text-align: ${"ar"===this.config.language?"right":"left"};\n        }\n\n        .tharwah-chat-message-content {\n          display: inline-block;\n          padding: 10px 16px;\n          border-radius: 16px;\n          max-width: 85%;\n          word-wrap: break-word;\n          font-size: 14px;\n          line-height: 1.6;\n        }\n\n        .tharwah-chat-message.bot .tharwah-chat-message-content {\n          background: #f3f4f6;\n          color: #1f2937;\n          box-shadow: none;\n        }\n\n        .tharwah-chat-message.user .tharwah-chat-message-content {\n          background: #2563eb;\n          color: white;\n        }\n\n        /* Typing indicator */\n        .tharwah-chat-typing {\n          display: inline-flex;\n          gap: 4px;\n          padding: 10px 14px;\n          background: white;\n          border-radius: 18px;\n          border-bottom-left-radius: 4px;\n          box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);\n        }\n\n        .tharwah-chat-typing span {\n          width: 8px;\n          height: 8px;\n          background: #a0aec0;\n          border-radius: 50%;\n          animation: bounce 1.4s infinite ease-in-out;\n        }\n\n        .tharwah-chat-typing span:nth-child(1) {\n          animation-delay: -0.32s;\n        }\n\n        .tharwah-chat-typing span:nth-child(2) {\n          animation-delay: -0.16s;\n        }\n\n        @keyframes bounce {\n          0%, 80%, 100% {\n            transform: translateY(0);\n          }\n          40% {\n            transform: translateY(-10px);\n          }\n        }\n\n        /* Message Feedback Buttons */\n        .tharwah-chat-message.bot {\n          display: flex;\n          align-items: flex-end;\n          gap: 8px;\n        }\n\n        .tharwah-feedback-buttons {\n          display: flex;\n          gap: 6px;\n          opacity: 0;\n          transition: opacity 0.2s;\n          flex-shrink: 0;\n          margin-bottom: 2px;\n        }\n\n        .tharwah-chat-message.bot:hover .tharwah-feedback-buttons {\n          opacity: 1;\n        }\n\n        .tharwah-chat-message.bot.last-message .tharwah-feedback-buttons {\n          opacity: 1;\n        }\n\n        .tharwah-feedback-btn {\n          background: transparent;\n          border: 1px solid #d1d5db;\n          border-radius: 4px;\n          padding: 3px 6px;\n          cursor: pointer;\n          transition: all 0.15s;\n          display: flex;\n          align-items: center;\n          justify-content: center;\n          min-width: 28px;\n          height: 24px;\n        }\n\n        .tharwah-feedback-btn svg {\n          width: 16px;\n          height: 16px;\n        }\n\n        .tharwah-feedback-btn:hover {\n          background: #f3f4f6;\n          border-color: #9ca3af;\n        }\n\n        .tharwah-feedback-btn:hover svg path,\n        .tharwah-feedback-btn:hover svg {\n          stroke: #374151;\n        }\n\n        .tharwah-feedback-btn.active {\n          background: #f3f4f6;\n          border-color: #6b7280;\n        }\n\n        .tharwah-feedback-btn.active.thumbs-up svg path,\n        .tharwah-feedback-btn.active.thumbs-up svg {\n          stroke: #374151;\n          fill: none;\n        }\n\n        .tharwah-feedback-btn.active.thumbs-down svg path,\n        .tharwah-feedback-btn.active.thumbs-down svg {\n          stroke: #374151;\n          fill: none;\n        }\n\n        .tharwah-feedback-btn:disabled {\n          cursor: not-allowed;\n          opacity: 0.3;\n        }\n\n        /* Input */\n        .tharwah-chat-input-container {\n          padding: 16px;\n          background: white;\n          border-top: 1px solid #e2e8f0;\n          display: flex;\n          gap: 8px;\n        }\n\n        .tharwah-chat-input {\n          flex: 1;\n          padding: 10px 16px;\n          border: 2px solid #e2e8f0;\n          border-radius: 20px;\n          font-size: 14px;\n          outline: none;\n          transition: border-color 0.2s;\n          /* Prevent iOS zoom */\n          font-size: 16px;\n          transform-origin: left;\n          transform: scale(0.875);\n        }\n\n        /* Adjust font size for desktop */\n        @media (min-width: 768px) {\n          .tharwah-chat-input {\n            font-size: 14px;\n            transform: scale(1);\n          }\n        }\n\n        .tharwah-chat-input:focus {\n          border-color: ${this.config.primaryColor};\n        }\n\n        .tharwah-chat-send {\n          background: #2563eb;\n          color: white;\n          border: none;\n          padding: 8px;\n          border-radius: 8px;\n          cursor: pointer;\n          transition: background 0.2s;\n          display: flex;\n          align-items: center;\n          justify-content: center;\n          width: 40px;\n        }\n\n        .tharwah-chat-send:hover {\n          background: #1d4ed8;\n        }\n\n        .tharwah-chat-send:disabled {\n          background: #d1d5db;\n          cursor: not-allowed;\n        }\n\n        .tharwah-chat-send svg {\n          width: 16px;\n          height: 16px;\n        }\n\n        /* Streaming cursor */\n        .streaming-cursor {\n          display: inline-block;\n          animation: smoothBlink 1.2s ease-in-out infinite;\n          color: ${this.config.primaryColor};\n          font-weight: bold;\n          margin-left: 2px;\n        }\n\n        @keyframes smoothBlink {\n          0% { opacity: 1; }\n          25% { opacity: 1; }\n          50% { opacity: 0.3; }\n          75% { opacity: 1; }\n          100% { opacity: 1; }\n        }\n\n        /* Small spinner for tools */\n        .spinner-small {\n          border: 2px solid #dbeafe;\n          border-top: 2px solid #2563eb;\n          border-radius: 50%;\n          width: 12px;\n          height: 12px;\n          animation: spin 1s linear infinite;\n          display: inline-block;\n        }\n\n        /* Mobile */\n        @media (max-width: 768px) {\n          .tharwah-chat-window {\n            width: 100% !important;\n            height: 100% !important;\n            top: 0 !important;\n            left: 0 !important;\n            bottom: 0 !important;\n            right: 0 !important;\n            border-radius: 0 !important;\n            max-height: 100vh !important;\n            margin: 0 !important;\n            /* Enhanced iOS touch handling for fullscreen */\n            position: fixed;\n            overscroll-behavior: contain;\n            -webkit-overflow-scrolling: touch;\n            touch-action: pan-y;\n          }\n\n          /* Prevent body scroll when chat is open on iOS */\n          body.tharwah-chat-open {\n            position: fixed;\n            width: 100%;\n            height: 100%;\n            overflow: hidden;\n          }\n          \n          .tharwah-chat-window.active {\n            display: flex !important;\n          }\n\n          .tharwah-chat-button.open {\n            display: none !important;\n          }\n        }\n\n        /* ========================================\n           ENROLLMENT FORM MODAL\n           ======================================== */\n        .tharwah-enrollment-modal {\n          position: fixed;\n          top: 0;\n          left: 0;\n          right: 0;\n          bottom: 0;\n          background: rgba(0, 0, 0, 0.5);\n          z-index: 1000000;\n          display: flex;\n          align-items: center;\n          justify-content: center;\n          padding: 20px;\n          opacity: 0;\n          transition: opacity 0.3s;\n        }\n\n        .tharwah-enrollment-modal.show {\n          opacity: 1;\n        }\n\n        .tharwah-enrollment-form {\n          background: white;\n          border-radius: 16px;\n          padding: 24px;\n          max-width: 420px;\n          width: 100%;\n          box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);\n          transform: scale(0.9);\n          transition: transform 0.3s;\n          max-height: 90vh;\n          overflow-y: auto;\n        }\n\n        .tharwah-enrollment-modal.show .tharwah-enrollment-form {\n          transform: scale(1);\n        }\n\n        .tharwah-enrollment-form h3 {\n          margin: 0 0 8px 0;\n          font-size: 20px;\n          font-weight: 700;\n          color: #111827;\n        }\n\n        .tharwah-enrollment-form .product-name {\n          font-size: 14px;\n          color: #6b7280;\n          margin-bottom: 20px;\n        }\n\n        .tharwah-enrollment-form label {\n          display: block;\n          font-size: 14px;\n          font-weight: 600;\n          color: #374151;\n          margin-bottom: 8px;\n        }\n\n        .tharwah-enrollment-form select {\n          width: 100%;\n          padding: 10px 12px;\n          border: 1px solid #d1d5db;\n          border-radius: 8px;\n          font-size: 14px;\n          margin-bottom: 16px;\n          background: white;\n          cursor: pointer;\n        }\n\n        .tharwah-enrollment-form select:focus {\n          outline: none;\n          border-color: #2563eb;\n          box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);\n        }\n\n        .tharwah-enrollment-form .form-group {\n          margin-bottom: 16px;\n        }\n\n        .tharwah-enrollment-form .button-group {\n          display: flex;\n          gap: 12px;\n          margin-top: 24px;\n        }\n\n        .tharwah-enrollment-form button {\n          flex: 1;\n          padding: 12px 24px;\n          border-radius: 8px;\n          font-size: 14px;\n          font-weight: 600;\n          cursor: pointer;\n          transition: all 0.2s;\n        }\n\n        .tharwah-enrollment-form .btn-cancel {\n          background: white;\n          border: 1px solid #d1d5db;\n          color: #374151;\n        }\n\n        .tharwah-enrollment-form .btn-cancel:hover {\n          background: #f9fafb;\n        }\n\n        .tharwah-enrollment-form .btn-enroll {\n          background: #2563eb;\n          border: none;\n          color: white;\n        }\n\n        .tharwah-enrollment-form .btn-enroll:hover {\n          background: #1d4ed8;\n        }\n\n        .tharwah-enrollment-form .btn-enroll:disabled {\n          background: #9ca3af;\n          cursor: not-allowed;\n        }\n\n        .tharwah-enrollment-form .price-info {\n          background: #eff6ff;\n          padding: 12px;\n          border-radius: 8px;\n          margin-bottom: 16px;\n        }\n\n        .tharwah-enrollment-form .price-label {\n          font-size: 12px;\n          color: #6b7280;\n          margin-bottom: 4px;\n        }\n\n        .tharwah-enrollment-form .price-value {\n          font-size: 24px;\n          font-weight: 700;\n          color: #2563eb;\n        }\n      `,n=t.createElement("style");n.textContent=e,t.head.appendChild(n)}createWidget(){const e=t.createElement("div");e.className="tharwah-chat-widget",e.innerHTML=`\n        <button class="tharwah-chat-button" id="tharwah-chat-button" aria-label="Open chat">\n          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" fill="currentColor">\n            <path d="M65.1,12.1H54.3V3.4h-8.6v8.6H34.9C17,12.1,2.5,26.2,2.5,43.7c0,17.4,14.5,31.6,32.4,31.6H37v-8.6h-2.2c-13.1,0-23.8-10.3-23.8-22.9c0-12.7,10.7-22.9,23.8-22.9h30.2c13.1,0,23.8,10.3,23.8,22.9c0,12.7-10.7,22.9-23.8,22.9H52.7L37,80.3v11.5l18.9-16.5h9.2c17.9,0,32.4-14.2,32.4-31.6C97.5,26.2,83,12.1,65.1,12.1z"/>\n            <circle cx="34.9" cy="44.5" r="6.5"/>\n            <circle cx="65.1" cy="44.5" r="6.5"/>\n          </svg>\n          <span class="tharwah-notification-badge" id="tharwah-chat-notification-badge">\n            <span class="tharwah-notification-ping" id="tharwah-chat-notification-ping"></span>\n            <span class="tharwah-notification-dot" id="tharwah-chat-notification-dot"></span>\n          </span>\n        </button>\n        \n        <div class="tharwah-chat-window" id="tharwah-chat-window">\n          <div class="tharwah-chat-header" id="tharwah-chat-header">\n            <h2>${this.getTitle()}</h2>\n            <div style="display: flex; align-items: center; gap: 8px;">\n              <button class="tharwah-chat-menu" id="tharwah-chat-menu" aria-label="Menu">\n                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n                  <circle cx="12" cy="12" r="1"></circle>\n                  <circle cx="12" cy="5" r="1"></circle>\n                  <circle cx="12" cy="19" r="1"></circle>\n                </svg>\n              </button>\n              <button class="tharwah-chat-close" id="tharwah-chat-close" aria-label="Close chat">\n                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n                  <path d="M18 6 6 18"></path>\n                  <path d="m6 6 12 12"></path>\n                </svg>\n              </button>\n            </div>\n          </div>\n          \n          \x3c!-- Menu Dropdown --\x3e\n          <div class="tharwah-chat-menu-dropdown" id="tharwah-chat-menu-dropdown" style="display: none;">\n            <label class="tharwah-menu-item" for="tharwah-chat-sound-checkbox" id="tharwah-chat-sound-toggle">\n              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n                <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>\n                <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path>\n              </svg>\n              <span>${"ar"===this.config.language?"ÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿßŸÑÿµŸàÿ™":"Sound Notifications"}</span>\n              <div class="tharwah-toggle-switch" id="tharwah-chat-toggle-switch">\n                <input type="checkbox" id="tharwah-chat-sound-checkbox" checked>\n                <span class="tharwah-toggle-slider" id="tharwah-chat-toggle-slider"></span>\n              </div>\n            </label>\n          </div>\n          \n          <div class="tharwah-chat-messages" id="tharwah-chat-messages"></div>\n          \n          <div class="tharwah-chat-input-container" id="tharwah-chat-input-container">\n            <input \n              type="text" \n              class="tharwah-chat-input" \n              id="tharwah-chat-input"\n              placeholder="${this.t("inputPlaceholder")}"\n              aria-label="Chat message"\n            />\n            <button class="tharwah-chat-send" id="tharwah-chat-send" aria-label="Send message">\n              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n                <path d="M14.536 21.686a.5.5 0 0 0 .937-.024l6.5-19a.496.496 0 0 0-.635-.635l-19 6.5a.5.5 0 0 0-.024.937l7.93 3.18a2 2 0 0 1 1.112 1.11z"></path>\n                <path d="m21.854 2.147-10.94 10.939"></path>\n              </svg>\n            </button>\n          </div>\n          \n          <div class="tharwah-feedback-section" id="tharwah-chat-feedback-section">\n            <button class="tharwah-feedback-trigger" id="tharwah-chat-feedback-trigger">\n              Give us your feedback\n            </button>\n          </div>\n        </div>\n      `,t.body.appendChild(e),this.elements={button:t.getElementById("tharwah-chat-button"),window:t.getElementById("tharwah-chat-window"),close:t.getElementById("tharwah-chat-close"),menu:t.getElementById("tharwah-chat-menu"),menuDropdown:t.getElementById("tharwah-chat-menu-dropdown"),soundCheckbox:t.getElementById("tharwah-chat-sound-checkbox"),messages:t.getElementById("tharwah-chat-messages"),input:t.getElementById("tharwah-chat-input"),send:t.getElementById("tharwah-chat-send"),inputContainer:t.querySelector(".tharwah-chat-input-container"),feedbackSection:t.getElementById("tharwah-chat-feedback-section"),feedbackTrigger:t.getElementById("tharwah-chat-feedback-trigger")};"false"===localStorage.getItem("tharwah-sound-enabled")&&(this.elements.soundCheckbox.checked=!1),this.isSoundEnabled=this.elements.soundCheckbox.checked}attachEventListeners(){this.elements.button.addEventListener("click",()=>this.toggle()),this.elements.close.addEventListener("click",()=>this.close()),this.elements.menu.addEventListener("click",()=>this.toggleMenu()),this.elements.send.addEventListener("click",()=>this.sendMessage()),this.elements.feedbackTrigger.addEventListener("click",()=>this.showFeedbackDialog()),this.elements.soundCheckbox.addEventListener("change",e=>{this.isSoundEnabled=e.target.checked,localStorage.setItem("tharwah-sound-enabled",this.isSoundEnabled),this.log("Sound notifications:",this.isSoundEnabled?"enabled":"disabled"),e.stopPropagation()}),this.elements.menuDropdown.addEventListener("click",e=>{e.stopPropagation()}),t.addEventListener("click",e=>{this.elements.menu.contains(e.target)||this.elements.menuDropdown.contains(e.target)||this.closeMenu()}),this.elements.input.addEventListener("keypress",e=>{"Enter"===e.key&&this.sendMessage()})}toggleMenu(){"block"===this.elements.menuDropdown.style.display?this.closeMenu():this.elements.menuDropdown.style.display="block"}closeMenu(){this.elements.menuDropdown.style.display="none"}playNotificationSound(){if(this.isSoundEnabled)try{const t=new(e.AudioContext||e.webkitAudioContext),n=t.createOscillator(),a=t.createGain();n.connect(a),a.connect(t.destination),n.frequency.value=1318.51,n.type="sine",a.gain.setValueAtTime(0,t.currentTime),a.gain.linearRampToValueAtTime(.15,t.currentTime+.05),a.gain.exponentialRampToValueAtTime(.01,t.currentTime+.3),n.start(t.currentTime),n.stop(t.currentTime+.3),this.log("Notification sound played")}catch(e){this.log("Error playing notification sound:",e)}else this.log("Sound notification skipped (disabled by user)")}toggle(){this.isOpen?this.close():this.open()}open(){this.isOpen=!0,this.elements.window.classList.add("active"),this.elements.button.classList.add("open"),this.elements.button.textContent="√ó",this.elements.input.focus(),e.innerWidth<=768&&(t.body.classList.add("tharwah-chat-open"),this.scrollPosition=e.pageYOffset),this.hidePopover(),this.trackEvent("chat_opened"),this.log("Chat opened")}close(){this.isOpen=!1,this.elements.window.classList.remove("active"),this.elements.button.classList.remove("open"),this.elements.button.textContent=this.config.buttonIcon,e.innerWidth<=768&&(t.body.classList.remove("tharwah-chat-open"),void 0!==this.scrollPosition&&e.scrollTo(0,this.scrollPosition)),this.trackEvent("chat_closed"),this.log("Chat closed")}hidePopover(){const e=t.getElementById("tharwah-chat-popover");e&&(e.style.display="none",this.log("Popover hidden because chat is open"))}addMessage(e,n="bot",a=null,i=!1){const o={id:a||Date.now(),content:e,sender:n,timestamp:new Date};this.messages.push(o);const s=t.createElement("div");s.className=`tharwah-chat-message ${n}`,s.setAttribute("data-message-id",o.id);const r="bot"===n?this.formatMessage(e):this.escapeHtml(e),l=this.isArabicText(e)?' style="direction: rtl; text-align: right;"':"",d="bot"!==n||i?"":`\n        <div class="tharwah-feedback-buttons" data-message-id="${o.id}" id="tharwah-chat-feedback-buttons-${o.id}">\n          <button class="tharwah-feedback-btn thumbs-up" data-feedback="positive" title="Thumbs up" id="tharwah-chat-feedback-thumbs-up-${o.id}">\n            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">\n              <path d="M9 10L9.74 9.877C9.7579 9.9844 9.7521 10.0945 9.7231 10.1995C9.6942 10.3045 9.6427 10.4019 9.5723 10.485C9.5018 10.5681 9.4142 10.6348 9.3153 10.6806C9.2165 10.7263 9.1089 10.75 9 10.75V10ZM20 10V9.25C20.1989 9.25 20.3897 9.329 20.5303 9.4697C20.671 9.6103 20.75 9.8011 20.75 10H20ZM18 20.75H6.64V19.25H18V20.75ZM5.44 9.25H9V10.75H5.44V9.25ZM8.26 10.123L7.454 5.288L8.934 5.041L9.74 9.877L8.26 10.123ZM9.18 3.25H9.394V4.75H9.181L9.18 3.25ZM12.515 4.92L15.03 8.693L13.782 9.525L11.267 5.752L12.515 4.92ZM16.07 9.25H20V10.75H16.07V9.25ZM20.75 10V18H19.25V10H20.75ZM3.943 18.54L2.743 12.54L4.213 12.245L5.413 18.245L3.943 18.54ZM15.03 8.693C15.1441 8.8643 15.2987 9.0037 15.4802 9.1009C15.6616 9.1981 15.8642 9.2489 16.07 9.249V10.749C15.15 10.749 14.292 10.29 13.782 9.525L15.03 8.693ZM7.454 5.288C7.4122 5.0373 7.4255 4.7795 7.4929 4.5344C7.5604 4.2894 7.6804 4.062 7.8447 3.868C8.009 3.6741 8.2135 3.5182 8.4441 3.4113C8.6747 3.3044 8.9258 3.25 9.18 3.25V4.749C9.1438 4.7491 9.108 4.7571 9.0751 4.7724C9.0422 4.7877 9.0131 4.8099 8.9897 4.8376C8.9663 4.8653 8.9492 4.8977 8.9396 4.9327C8.93 4.9676 8.9281 5.0052 8.934 5.041L7.454 5.288ZM5.44 10.749C5.2551 10.749 5.0724 10.79 4.9052 10.8691C4.738 10.9481 4.5905 11.0634 4.4732 11.2064C4.3559 11.3494 4.2718 11.5166 4.227 11.6961C4.1822 11.8755 4.1778 12.0626 4.214 12.244L2.743 12.539C2.6633 12.14 2.673 11.7273 2.7716 11.3326C2.8702 10.9378 3.0552 10.5699 3.3132 10.2553C3.5712 9.9407 3.8958 9.6872 4.2635 9.5132C4.6313 9.3392 5.0331 9.2489 5.44 9.249V10.749ZM6.64 20.75C6.0043 20.7501 5.3882 20.529 4.8965 20.1261C4.4048 19.7232 4.0678 19.1633 3.943 18.54L5.413 18.245C5.4695 18.5288 5.6227 18.7832 5.8464 18.9666C6.0702 19.1501 6.3506 19.2502 6.64 19.25V20.75ZM9.394 3.25C10.0113 3.25 10.6191 3.4015 11.1634 3.6928C11.7077 3.9841 12.1716 4.4053 12.514 4.919L11.267 5.751C11.0615 5.4427 10.7829 5.1899 10.4562 5.0151C10.1294 4.8403 9.7646 4.7499 9.394 4.75V3.25ZM18 19.25C18.69 19.25 19.25 18.69 19.25 18H20.75C20.75 18.7293 20.4603 19.4288 19.9445 19.9445C19.4288 20.4603 18.7293 20.75 18 20.75V19.25Z" fill="#AAAAAA"/>\n              <path d="M16 10V20" stroke="#AAAAAA" stroke-width="1.5"/>\n            </svg>\n          </button>\n          <button class="tharwah-feedback-btn thumbs-down" data-feedback="negative" title="Thumbs down" id="tharwah-chat-feedback-thumbs-down-${o.id}">\n            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">\n              <path d="M15 14L14.26 14.123C14.2421 14.0156 14.2479 13.9055 14.2769 13.8005C14.3058 13.6955 14.3573 13.5981 14.4277 13.515C14.4982 13.432 14.5858 13.3652 14.6847 13.3194C14.7835 13.2737 14.8911 13.25 15 13.25V14ZM4 14V14.75C3.80109 14.75 3.61032 14.671 3.46967 14.5303C3.32902 14.3897 3.25 14.1989 3.25 14H4ZM6 3.25H17.36V4.75H6V3.25ZM18.56 14.75H15V13.25H18.56V14.75ZM15.74 13.877L16.546 18.712L15.066 18.959L14.26 14.123L15.74 13.877ZM14.82 20.75H14.606V19.25H14.819L14.82 20.75ZM11.485 19.08L8.97 15.307L10.218 14.475L12.733 18.248L11.485 19.08ZM7.93 14.75H4V13.25H7.93V14.75ZM3.25 14V6H4.75V14H3.25ZM20.057 5.46L21.257 11.46L19.787 11.755L18.587 5.755L20.057 5.46ZM8.97 15.307C8.8559 15.1357 8.70127 14.9963 8.51985 14.8991C8.33842 14.8019 8.13581 14.7511 7.93 14.751V13.251C8.85 13.251 9.708 13.71 10.218 14.475L8.97 15.307ZM16.546 18.712C16.5878 18.9627 16.5745 19.2205 16.5071 19.4656C16.4396 19.7106 16.3196 19.938 16.1553 20.132C15.991 20.3259 15.7865 20.4818 15.5559 20.5887C15.3253 20.6956 15.0742 20.75 14.82 20.75V19.251C14.8562 19.2509 14.892 19.2429 14.9249 19.2276C14.9578 19.2123 14.9869 19.1901 15.0103 19.1624C15.0337 19.1347 15.0508 19.1023 15.0604 19.0673C15.07 19.0324 15.0719 18.9948 15.066 18.959L16.546 18.712ZM18.56 13.251C18.7449 13.251 18.9276 13.21 19.0948 13.1309C19.262 13.0519 19.4095 12.9366 19.5268 12.7936C19.6441 12.6506 19.7282 12.4834 19.773 12.3039C19.8178 12.1245 19.8222 11.9374 19.786 11.756L21.257 11.461C21.3367 11.86 21.327 12.2727 21.2284 12.6674C21.1298 13.0622 20.9448 13.4301 20.6868 13.7447C20.4288 14.0593 20.1042 14.3128 19.7365 14.4868C19.3687 14.6608 18.9669 14.7511 18.56 14.751V13.251ZM17.36 3.25C17.9957 3.24988 18.6118 3.471 19.1035 3.87392C19.5952 4.27684 19.9322 4.83667 20.057 5.46L18.587 5.755C18.5305 5.47122 18.3773 5.21682 18.1536 5.03336C17.9298 4.84991 17.6494 4.74976 17.36 4.75V3.25ZM14.606 20.75C13.9887 20.75 13.3809 20.5985 12.8366 20.3072C12.2923 20.0159 11.8284 19.5947 11.486 19.081L12.733 18.249C12.9385 18.5573 13.2171 18.8101 13.5438 18.9849C13.8706 19.1597 14.2354 19.2501 14.606 19.25V20.75ZM6 4.75C5.31 4.75 4.75 5.31 4.75 6H3.25C3.25 5.27065 3.53973 4.57118 4.05546 4.05546C4.57118 3.53973 5.27065 3.25 6 3.25V4.75Z" fill="#AAAAAA"/>\n              <path d="M8 14V4" stroke="#AAAAAA" stroke-width="1.5"/>\n            </svg>\n          </button>\n        </div>\n      `;if(s.innerHTML=`\n        <div class="tharwah-chat-message-content"${l}>${r}</div>\n        ${d}\n      `,"bot"===n&&!i){const e=s.querySelector(".thumbs-up"),t=s.querySelector(".thumbs-down"),n=s.querySelector(".tharwah-feedback-buttons");e?.addEventListener("click",()=>{const a=n.getAttribute("data-message-id");this.submitMessageFeedback(a,"positive",e,t)}),t?.addEventListener("click",()=>{const a=n.getAttribute("data-message-id");this.submitMessageFeedback(a,"negative",e,t)})}if(this.elements.messages.appendChild(s),"bot"===n){this.elements.messages.querySelectorAll(".tharwah-chat-message.bot").forEach(e=>e.classList.remove("last-message")),s.classList.add("last-message")}return"user"===n?this.scrollToBottom():this.scrollToMessage(s),o}showTyping(){if(this.isTyping)return;this.isTyping=!0;const e=t.createElement("div");e.className="tharwah-chat-message bot",e.id="tharwah-typing-indicator",e.innerHTML='\n        <div class="tharwah-chat-typing">\n          <span></span>\n          <span></span>\n          <span></span>\n        </div>\n      ',this.elements.messages.appendChild(e),this.scrollToBottom()}hideTyping(){this.isTyping=!1;const e=t.getElementById("tharwah-typing-indicator");e&&e.remove()}scrollToBottom(){this.elements.messages.scrollTop=this.elements.messages.scrollHeight}scrollToMessage(e){const t=this.elements.messages,n=t.querySelectorAll(".tharwah-chat-message");let a=e;for(let t=Array.from(n).indexOf(e)-1;t>=0;t--)if(n[t].classList.contains("user")){a=n[t];break}const i=a.offsetTop;t.scrollTop=Math.max(0,i-40)}showFeedbackButton(){this.elements.feedbackSection&&!this.feedbackSubmitted&&this.elements.feedbackSection.classList.add("show")}hideFeedbackSection(){this.elements.feedbackSection&&this.elements.feedbackSection.classList.remove("show")}showFeedbackDialog(){if(!this.conversationId)return void this.log("No conversation to rate");if(this.feedbackSubmitted)return void this.log("Feedback already submitted for this conversation");const e=t.createElement("div");e.id="tharwah-feedback-dialog",e.className="tharwah-feedback-overlay";const n=[{value:"",label:this.t("feedbackCategoryPlaceholder")},{value:"helpful",label:this.t("categoryHelpful")},{value:"unhelpful",label:this.t("categoryUnhelpful")},{value:"incorrect",label:this.t("categoryIncorrect")},{value:"slow",label:this.t("categorySlow")},{value:"bug",label:this.t("categoryBug")},{value:"feature",label:this.t("categoryFeature")},{value:"other",label:this.t("categoryOther")}];e.innerHTML=`\n        <div class="tharwah-feedback-dialog-content" id="tharwah-chat-feedback-dialog-content">\n          <div class="tharwah-feedback-header" id="tharwah-chat-feedback-header">\n            <h3>${this.t("feedbackTitle")}</h3>\n            <p>${this.t("feedbackSubtitle")}</p>\n          </div>\n\n          <div class="tharwah-feedback-body" id="tharwah-chat-feedback-body">\n            \x3c!-- Star Rating --\x3e\n            <div class="tharwah-star-rating" id="tharwah-chat-star-rating">\n              ${[1,2,3,4,5].map(e=>`\n                <button type="button" class="tharwah-star" data-rating="${e}" aria-label="${e} stars" id="tharwah-chat-star-${e}">\n                  <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n                    <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>\n                  </svg>\n                </button>\n              `).join("")}\n            </div>\n            \n            \x3c!-- Category Selection --\x3e\n            <div class="tharwah-feedback-field" id="tharwah-chat-feedback-category-field">\n              <label>${this.t("feedbackCategoryLabel")}</label>\n              <select id="tharwah-chat-feedback-category" class="tharwah-feedback-select">\n                ${n.map(e=>`<option value="${e.value}">${e.label}</option>`).join("")}\n              </select>\n            </div>\n\n            \x3c!-- Text Feedback --\x3e\n            <div class="tharwah-feedback-field" id="tharwah-chat-feedback-text-field">\n              <label>${this.t("feedbackTextLabel")}</label>\n              <textarea\n                id="tharwah-chat-feedback-text"\n                class="tharwah-feedback-textarea"\n                placeholder="${this.t("feedbackTextPlaceholder")}"\n                rows="4"\n              ></textarea>\n            </div>\n          </div>\n\n          <div class="tharwah-feedback-actions" id="tharwah-chat-feedback-actions">\n            <button type="button" id="tharwah-chat-feedback-cancel" class="tharwah-feedback-btn tharwah-feedback-btn-secondary">\n              Cancel\n            </button>\n            <button type="button" id="tharwah-chat-feedback-submit" class="tharwah-feedback-btn tharwah-feedback-btn-primary" disabled>\n              Submit Feedback\n            </button>\n          </div>\n        </div>\n      `,t.body.appendChild(e);let a=0;const i=e.querySelectorAll(".tharwah-star"),o=e.querySelector("#tharwah-chat-feedback-submit"),s=e=>{i.forEach((t,n)=>{const a=t.querySelector("svg");n<e?(a.style.fill="#fbbf24",a.style.stroke="#fbbf24"):(a.style.fill="none",a.style.stroke="#d1d5db")})};i.forEach(e=>{e.addEventListener("mouseenter",e=>{const t=parseInt(e.currentTarget.dataset.rating);s(t)}),e.addEventListener("click",e=>{a=parseInt(e.currentTarget.dataset.rating),s(a),o.disabled=!1,this.log("Rating selected:",a)})}),e.addEventListener("mouseleave",()=>{s(a)}),e.querySelector("#tharwah-chat-feedback-cancel").addEventListener("click",()=>{t.body.removeChild(e),this.trackEvent("feedback_cancelled")}),o.addEventListener("click",async()=>{const n=e.querySelector("#tharwah-chat-feedback-category").value,i=e.querySelector("#tharwah-chat-feedback-text").value.trim();o.disabled=!0,o.textContent="ar"===this.config.language?"ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ•ÿ±ÿ≥ÿßŸÑ...":"Submitting...";if(await this.submitFeedback(a,n,i))e.querySelector(".tharwah-feedback-dialog-content").innerHTML=`\n            <div style="text-align: center; padding: 32px;">\n              <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin: 0 auto 16px;">\n                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>\n                <polyline points="22 4 12 14.01 9 11.01"></polyline>\n              </svg>\n              <h3 style="color: #10b981; margin-bottom: 8px;">${this.t("feedbackSuccess")}</h3>\n            </div>\n          `,setTimeout(()=>{t.body.removeChild(e)},2e3);else{o.disabled=!1,o.textContent=this.t("feedbackSubmit");const n=t.createElement("div");n.style.cssText="color: #ef4444; font-size: 14px; margin-top: 8px; text-align: center;",n.textContent=this.t("feedbackError"),e.querySelector(".tharwah-feedback-actions").appendChild(n)}}),this.trackEvent("feedback_dialog_opened")}async submitFeedback(e,t,n){try{if(!this.conversationId)throw new Error("No conversation ID");if(!this.config.apiKey)throw new Error("API key is not configured");const a=sessionStorage.getItem("tharwah_user_email")||"",i={rating:e,feedback_text:n,language:this.config.language||"en"};t&&(i.category=t),a&&(i.submitted_by_email=a),this.log("Submitting feedback:",i);const o=await fetch(`${this.config.apiEndpoint}/widget/conversations/${this.conversationId}/feedback/`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.config.apiKey}`},body:JSON.stringify(i)});if(!o.ok){const e=await o.json().catch(()=>({}));throw new Error(`API Error ${o.status}: ${JSON.stringify(e)}`)}const s=await o.json();return this.log("Feedback submitted successfully:",s),this.feedbackSubmitted=!0,this.hideFeedbackSection(),this.trackEvent("feedback_submitted",{rating:e,has_category:!!t,has_text:!!n,has_email:!!a}),!0}catch(e){return this.log("Error submitting feedback:",e),this.trackEvent("feedback_error",{error:e.message}),!1}}trackEvent(t,n={}){e.tracker&&"function"==typeof e.tracker.event&&e.tracker.event(t,{...n,source:"tharwah_chat_widget",timestamp:Date.now()});const a=new CustomEvent("tharwah-chat:event",{detail:{event:t,data:n}});e.dispatchEvent(a)}async submitMessageFeedback(t,n,a,i){try{this.log(`Submitting ${n} feedback for message ${t}`),a.disabled=!0,i.disabled=!0;let o=t;if("string"==typeof t){const e=t.match(/\d+$/);o=e?parseInt(e[0],10):parseInt(t,10)}this.log(`Numeric message ID: ${o}`);const s=await fetch(`${this.config.apiEndpoint}/widget/conversations/message-feedback/`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.config.apiKey}`},body:JSON.stringify({message:o,conversation:this.conversationId,feedback_type:n,visitor_id:this.getVisitorId(),metadata:{user_agent:navigator.userAgent,page_url:e.location.href,timestamp:(new Date).toISOString()}})});if(!s.ok){const e=await s.json().catch(()=>({}));if(400===s.status&&e.error)return void this.log("Feedback already submitted for this message");throw new Error(`Failed to submit feedback: ${s.status}`)}const r=await s.json();this.log("Feedback submitted successfully:",r),"positive"===n?(a.classList.add("active"),i.classList.remove("active")):(i.classList.add("active"),a.classList.remove("active")),this.trackEvent("message_feedback_submitted",{message_id:t,feedback_type:n})}catch(e){this.log("Error submitting message feedback:",e),a.disabled=!1,i.disabled=!1,this.trackEvent("message_feedback_error",{error:e.message})}}escapeHtml(e){const n=t.createElement("div");return n.textContent=e,n.innerHTML}escapeHtmlExceptTables(e){const t=[];let n=e.replace(/<table[\s\S]*?<\/table>/g,e=>{const n=`___TABLE_${t.length}___`;return t.push(e),n});return n=this.escapeHtml(n),t.forEach((e,t)=>{n=n.replace(`___TABLE_${t}___`,e)}),n}isArabicText(e){return/[\u0600-\u06FF\u0750-\u077F]/.test(e)}formatMessage(e){let t=this.convertMarkdownTables(e);return t=this.escapeHtmlExceptTables(t),t=t.replace(/\*\*([^*]+)\*\*/g,"<strong>$1</strong>"),t=t.replace(/\n/g,"<br>"),t=t.replace(/([a-zA-Z\?])\s*:\s*(?=<br>|$)/g,"$1:<br><br>"),t=t.replace(/^(\d+)\.\s+\*\*(.+?)\*\*/gm,"<br><strong>$1. $2</strong><br>"),t=t.replace(/^(\d+)\.\s+/gm,"<br><strong>$1.</strong> "),t=t.replace(/^-\s+/gm,"<br>&nbsp;&nbsp;&nbsp;‚Ä¢ "),t=t.replace(/(<br>){3,}/g,"<br><br>"),t=t.replace(/^<br>/,""),t}convertMarkdownTables(e){return e.replace(/^\s*\|(.+)\|\s*\n\s*\|(?:[\s\-:]+\|)+\s*\n((?:\s*\|.+\|\s*\n?)+)/gm,(e,n,a)=>{this.config.debug&&console.log("[TharwahChat] Found markdown table!",{headerRow:n,bodyRows:a});const i=n.split("|").map(e=>e.trim()).filter(e=>e.length>0),o=a.trim().split("\n").map(e=>e.split("|").map(e=>e.trim()).filter(e=>e.length>0)),s=e=>{const n=t.createElement("div");return n.textContent=e,n.innerHTML};let r='\n<table style="width: 100%; border-collapse: collapse; margin: 10px 0; font-size: 13px; background: white; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border-radius: 8px; overflow: hidden;">';return r+='<thead><tr style="background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); color: white;">',i.forEach(e=>{r+=`<th style="padding: 10px 12px; text-align: left; font-weight: 600; border-bottom: 2px solid #1e40af;">${s(e)}</th>`}),r+="</tr></thead>",r+="<tbody>",o.forEach((e,t)=>{const n=t%2==0?"#f9fafb":"white";r+=`<tr style="background: ${n}; transition: background 0.2s;" onmouseover="this.style.background='#eff6ff'" onmouseout="this.style.background='${n}'">`,e.forEach(e=>{r+=`<td style="padding: 10px 12px; border-bottom: 1px solid #e5e7eb;">${s(e)}</td>`}),r+="</tr>"}),r+="</tbody>",r+="</table>\n",r})}log(...e){this.config.debug&&console.log("[TharwahChat]",...e)}destroy(){const e=t.querySelector(".tharwah-chat-widget");e&&e.remove(),this.log("Widget destroyed")}sendMessageProgrammatically(e){this.elements.input.value=e,this.sendMessage()}showEnrollmentForm(n){const a=n.metadata||{},i=(a.course_type,a.virtual_dates||[]),o=a.locations||[],s=new Date;s.setHours(0,0,0,0);const r=i.filter(e=>new Date(e)>=s),l=a.wp_id||n.id,d=a.price||n.price||0,h=a.currency||n.currency||"SAR",c=n.name||"Course",g=n.enroll_link||n.product_link||"",p=r.length>0,u=o.length>1;if(!p)return void(g?(e.open(g,"_blank"),this.addMessage("‚úÖ Opening enrollment page...","bot")):this.addMessage("Sorry, enrollment is not available at this time. Please contact support.","bot"));const m=t.createElement("div");m.className="tharwah-chat-message bot enrollment-form-message",m.dataset.productId=l,m.dataset.enrollLink=g,m.innerHTML=`\n        <div class="tharwah-chat-message-content" style="\n          padding: 0;\n          background: white;\n          border: 1px solid #e5e7eb;\n          border-radius: 8px;\n          overflow: hidden;\n          max-width: 100%;\n        ">\n          \x3c!-- Header --\x3e\n          <div style="\n            background: #f9fafb;\n            border-bottom: 1px solid #e5e7eb;\n            padding: 12px 16px;\n          ">\n            <h3 style="margin: 0 0 4px 0; font-size: 15px; font-weight: 600; color: #111827;">\n              ${this.escapeHtml(c)}\n            </h3>\n            <p style="margin: 0; font-size: 12px; color: #6b7280;">\n              ${h} ${d.toLocaleString()}\n            </p>\n          </div>\n          \n          \x3c!-- Form --\x3e\n          <form id="enrollmentFormData" style="padding: 16px;">\n            \n            \x3c!-- Date Selection (Always shown if dates available) --\x3e\n            <div style="margin-bottom: 12px;">\n              <label style="\n                display: block;\n                font-size: 12px;\n                font-weight: 500;\n                color: #374151;\n                margin-bottom: 4px;\n              ">\n                ${"ar"===this.config.language?"ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿØŸàÿ±ÿ©":"Course Date"}\n                <span style="color: #ef4444;">*</span>\n              </label>\n              <select \n                id="virtual_date" \n                name="virtual_date" \n                required\n                style="\n                  width: 100%;\n                  padding: 8px 10px;\n                  border: 1px solid #d1d5db;\n                  border-radius: 6px;\n                  font-size: 13px;\n                  color: #374151;\n                  background: white;\n                  cursor: pointer;\n                "\n              >\n                <option value="">${"ar"===this.config.language?"ÿßÿÆÿ™ÿ± ÿßŸÑÿ™ÿßÿ±ŸäÿÆ...":"Select date..."}</option>\n                ${r.map(e=>{const[t,n,a]=e.split("-");return'<option value="'+(a+"-"+n+"-"+t)+'">'+("ar"===this.config.language?e:new Date(e).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric"}))+"</option>"}).join("")}\n              </select>\n            </div>\n            \n            \x3c!-- Location Selection (Only shown if multiple locations) --\x3e\n            ${u?`\n            <div style="margin-bottom: 12px;">\n              <label style="\n                display: block;\n                font-size: 12px;\n                font-weight: 500;\n                color: #374151;\n                margin-bottom: 4px;\n              ">\n                ${"ar"===this.config.language?"ÿßŸÑŸÖŸàŸÇÿπ":"Location"}\n                <span style="color: #ef4444;">*</span>\n              </label>\n              <select \n                id="location" \n                name="location" \n                required\n                style="\n                  width: 100%;\n                  padding: 8px 10px;\n                  border: 1px solid #d1d5db;\n                  border-radius: 6px;\n                  font-size: 13px;\n                  color: #374151;\n                  background: white;\n                  cursor: pointer;\n                "\n              >\n                <option value="">${"ar"===this.config.language?"ÿßÿÆÿ™ÿ± ÿßŸÑŸÖŸàŸÇÿπ...":"Select location..."}</option>\n                ${o.map(e=>'<option value="'+this.escapeHtml(e)+'">'+this.escapeHtml(e)+"</option>").join("")}\n              </select>\n            </div>\n            `:""}\n            \n            <input type="hidden" name="product_id" value="${l}">\n            <input type="hidden" name="quantity" value="1">\n            ${!u&&o.length>0?'<input type="hidden" name="location" value="'+this.escapeHtml(o[0])+'">':""}\n            \n            \x3c!-- Buttons --\x3e\n            <div style="\n              display: grid;\n              grid-template-columns: 1fr 1fr;\n              gap: 8px;\n              margin-top: 16px;\n            ">\n              <button\n                type="button"\n                id="tharwah-chat-enrollment-cancel"\n                onclick="this.closest('.enrollment-form-message').remove()"\n                style="\n                  padding: 10px;\n                  border: 1px solid #d1d5db;\n                  background: white;\n                  color: #6b7280;\n                  border-radius: 6px;\n                  font-size: 13px;\n                  font-weight: 500;\n                  cursor: pointer;\n                "\n              >\n                ${"ar"===this.config.language?"ÿ•ŸÑÿ∫ÿßÿ°":"Cancel"}\n              </button>\n              <button\n                type="submit"\n                id="tharwah-chat-enrollment-submit"\n                style="\n                  padding: 10px;\n                  border: 1px solid #2563eb;\n                  background: #2563eb;\n                  color: white;\n                  border-radius: 6px;\n                  font-size: 13px;\n                  font-weight: 600;\n                  cursor: pointer;\n                  transition: background 0.2s;\n                "\n                onmouseover="this.style.background='#1d4ed8'"\n                onmouseout="this.style.background='#2563eb'"\n              >\n                ${"ar"===this.config.language?"üéì ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿ¢ŸÜ":"üéì Enroll Now"}\n              </button>\n            </div>\n          </form>\n        </div>\n      `,this.elements.messages.appendChild(m),this.scrollToBottom();m.querySelector("#enrollmentFormData").addEventListener("submit",e=>{e.preventDefault(),this.submitEnrollment(e.target,m)})}closeEnrollmentForm(){}async submitEnrollment(e,n){const a=new FormData(e),i=a.get("virtual_date"),o=a.get("location"),s=a.get("product_id"),r=a.get("quantity");if(!i)return void this.addMessage("ar"===this.config.language?"‚ö†Ô∏è Ÿäÿ±ÿ¨Ÿâ ÿßÿÆÿ™Ÿäÿßÿ± ÿßŸÑÿ™ÿßÿ±ŸäÿÆ":"‚ö†Ô∏è Please select a date","bot");if(e.querySelector("#location")&&!o)return void this.addMessage("ar"===this.config.language?"‚ö†Ô∏è Ÿäÿ±ÿ¨Ÿâ ÿßÿÆÿ™Ÿäÿßÿ± ÿßŸÑŸÖŸàŸÇÿπ":"‚ö†Ô∏è Please select a location","bot");const l=e.querySelector('button[type="submit"]'),d=l.innerHTML;l&&(l.disabled=!0,l.innerHTML="ar"===this.config.language?"‚è≥ ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ•ÿ∂ÿßŸÅÿ©...":"‚è≥ Adding to cart...");try{const a="ar"===this.config.language?"https://academy.tharwah.net/ar/ÿßŸÑÿ≥ŸÑÿ©/":"https://academy.tharwah.net/cart/",l=t.createElement("form");l.method="POST",l.action=a,l.target="_blank",l.style.display="none";const d={"add-to-cart":s,quantity:r,training_type:"virtual",virtual_date:i};e.querySelector("#location")&&o&&(d.location=o),Object.keys(d).forEach(e=>{const n=t.createElement("input");n.type="hidden",n.name=e,n.value=d[e],l.appendChild(n)}),this.log("Submitting enrollment:",d),t.body.appendChild(l),l.submit(),setTimeout(()=>{t.body.removeChild(l)},1e3),n&&n.remove();const h="ar"===this.config.language?"‚úÖ ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿØŸàÿ±ÿ© ÿ•ŸÑŸâ ÿßŸÑÿ≥ŸÑÿ©! Ÿäÿ±ÿ¨Ÿâ ÿ•ŸÉŸÖÿßŸÑ ÿπŸÖŸÑŸäÿ© ÿßŸÑÿØŸÅÿπ ŸÅŸä ÿßŸÑŸÜÿßŸÅÿ∞ÿ© ÿßŸÑÿ¨ÿØŸäÿØÿ©.":"‚úÖ Course added to cart! Please complete checkout in the new tab.";this.addMessage(h,"bot"),this.trackEvent("course_enrollment_submitted",{product_id:s,date:i,location:o||"N/A",training_type:"virtual"})}catch(e){this.log("Enrollment error:",e);const t="ar"===this.config.language?"‚ùå ŸÅÿ¥ŸÑ ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ. Ÿäÿ±ÿ¨Ÿâ ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ ÿ£Ÿà ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑÿØÿπŸÖ.":"‚ùå Enrollment failed. Please try again or contact support.";this.addMessage(t,"bot"),l&&(l.disabled=!1,l.innerHTML=d),this.trackEvent("course_enrollment_error",{error:e.message,product_id:s})}}showB2BServiceCards(e){const n=e.map(e=>{const t=this.escapeHtml(e.name).replace(/'/g,"\\'"),n=e.attachment_url?`${this.config.apiEndpoint.replace(/\/api\/?$/,"")}${e.attachment_url}`:null;return this.config.debug&&console.log("[TharwahChat] Rendering B2B service:",t,n),`\n          <div style="\n            background: white;\n            border: 1px solid #e5e7eb;\n            border-radius: 12px;\n            overflow: hidden;\n            box-shadow: 0 1px 3px rgba(0,0,0,0.1);\n            transition: all 0.2s;\n            flex-shrink: 0;\n            width: 200px;\n            cursor: pointer;\n          "\n          onmouseover="this.style.boxShadow='0 4px 6px rgba(0,0,0,0.1)'"\n          onmouseout="this.style.boxShadow='0 1px 3px rgba(0,0,0,0.1)'"\n          onclick="window.tharwahChatWidget.showB2BRequestForm('${e.id}', '${t}')"\n          >\n            \x3c!-- Image/Icon --\x3e\n            <div style="position: relative;">\n              ${n?`<img src="${n}" alt="${this.escapeHtml(e.name)}" style="width: 100%; height: 96px; object-fit: cover;" onerror="this.parentElement.innerHTML='<div style=\\'width: 100%; height: 96px; background: linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 100%); display: flex; align-items: center; justify-content: center; font-size: 2rem;\\'>üè¢</div>';" />`:'<div style="width: 100%; height: 96px; background: linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 100%); display: flex; align-items: center; justify-content: center; font-size: 2rem;">\n                üè¢\n              </div>'}\n            </div>\n\n            \x3c!-- Content --\x3e\n            <div style="padding: 12px;">\n              \x3c!-- Title --\x3e\n              <h4 style="\n                font-size: 13px;\n                font-weight: 600;\n                color: #111827;\n                margin: 0 0 6px 0;\n                line-height: 1.3;\n                display: -webkit-box;\n                -webkit-line-clamp: 2;\n                -webkit-box-orient: vertical;\n                overflow: hidden;\n                height: 32px;\n              ">${this.escapeHtml(e.name)}</h4>\n\n              \x3c!-- Description --\x3e\n              <p style="\n                font-size: 11px;\n                color: #6b7280;\n                margin: 0 0 8px 0;\n                line-height: 1.4;\n                display: -webkit-box;\n                -webkit-line-clamp: 3;\n                -webkit-box-orient: vertical;\n                overflow: hidden;\n                height: 46px;\n              ">${this.escapeHtml(e.description||("ar"===this.config.language?"ÿßÿ≠ÿµŸÑ ÿπŸÑŸâ ÿßÿ≥ÿ™ÿ¥ÿßÿ±ÿ© ŸÖÿ™ÿÆÿµÿµÿ© ŸÅŸä Ÿáÿ∞Ÿá ÿßŸÑÿÆÿØŸÖÿ©":"Get specialized consultation for this service"))}</p>\n\n              \x3c!-- Request Button --\x3e\n              <button\n                style="\n                  width: 100%;\n                  padding: 6px 12px;\n                  background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);\n                  color: white;\n                  border: none;\n                  border-radius: 6px;\n                  font-size: 11px;\n                  font-weight: 600;\n                  cursor: pointer;\n                  transition: all 0.2s;\n                "\n                onmouseover="this.style.background='#1d4ed8'"\n                onmouseout="this.style.background='#2563eb'"\n                onclick="event.stopPropagation(); window.tharwahChatWidget.showB2BRequestForm('${e.id}', '${t}')"\n              >\n                ${"ar"===this.config.language?"ÿ∑ŸÑÿ® ÿßŸÑÿÆÿØŸÖÿ©":"Request Service"}\n              </button>\n            </div>\n          </div>\n        `}).join(""),a=`\n        <div class="tharwah-chat-message bot" style="margin-bottom: 12px;">\n          <div class="tharwah-chat-message-content" style="max-width: 100%; padding: 0; background: transparent; box-shadow: none;">\n            <div style="background: #f8fafc; border-radius: 8px; padding: 8px;">\n              <div style="\n                display: flex;\n                align-items: center;\n                gap: 6px;\n                margin-bottom: 8px;\n                padding: 0 4px;\n              ">\n                <span style="color: #2563eb;">üè¢</span>\n                <h4 style="\n                  font-size: 14px;\n                  font-weight: 600;\n                  color: #1f2937;\n                  margin: 0;\n                ">\n                  ${"ar"===this.config.language?"ÿÆÿØŸÖÿßÿ™ŸÜÿß ÿßŸÑŸÖÿ™ÿÆÿµÿµÿ© ŸÑŸÑÿ¥ÿ±ŸÉÿßÿ™":"Our Specialized B2B Services"}\n                </h4>\n              </div>\n\n              <div style="\n                display: flex;\n                gap: 8px;\n                overflow-x: auto;\n                padding-bottom: 4px;\n                -webkit-overflow-scrolling: touch;\n                scrollbar-width: thin;\n                scrollbar-color: #cbd5e1 #f1f5f9;\n              ">\n                ${n}\n              </div>\n\n              <p style="\n                font-size: 11px;\n                color: #6b7280;\n                margin: 8px 4px 0 0;\n                text-align: center;\n                font-style: italic;\n              ">\n                ${"ar"===this.config.language?"üí° ÿßŸÜŸÇÿ± ÿπŸÑŸâ ÿ£Ÿä ÿÆÿØŸÖÿ© ŸÑŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿßÿ≥ÿ™ÿ¥ÿßÿ±ÿ© ŸÖÿ™ÿÆÿµÿµÿ©":"üí° Click on any service to get specialized consultation"}\n              </p>\n            </div>\n          </div>\n        </div>\n      `,i=t.createElement("div");i.innerHTML=a;const o=i.firstElementChild;this.elements.messages.appendChild(o),this.scrollToBottom()}showB2BRequestForm(n=null){const a=t.querySelector(".b2b-request-form-message");a&&a.remove();const i=sessionStorage.getItem("tharwah_user_email")||"",o=n||"",s=`\n        <div class="tharwah-chat-message bot b2b-request-form-message" style="margin-bottom: 12px;">\n          <div style="\n            background: white;\n            border-radius: 12px;\n            padding: 20px;\n            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.1);\n          ">\n            <h4 style="\n              font-size: 16px;\n              font-weight: 600;\n              color: #1f2937;\n              margin: 0 0 4px 0;\n              display: flex;\n              align-items: center;\n              gap: 8px;\n            ">\n              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#2563eb" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>\n                <path d="M9 11l3 3L22 4"></path>\n              </svg>\n              ${"ar"===this.config.language?"ŸÜŸÖŸàÿ∞ÿ¨ ÿ∑ŸÑÿ® ÿßŸÑÿÆÿØŸÖÿ©":"Service Request Form"}\n            </h4>\n            <p style="font-size: 12px; color: #6b7280; margin: 0 0 16px 0;">\n              ${"ar"===this.config.language?"Ÿäÿ±ÿ¨Ÿâ ŸÖŸÑÿ° ÿßŸÑÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿÆÿßÿµÿ© ÿ®ŸÉ":"Please fill in your details"}\n            </p>\n\n            <form id="b2bRequestForm">\n              \x3c!-- First Name --\x3e\n              <div style="margin-bottom: 12px;">\n                <label style="display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 4px;">\n                  ${"ar"===this.config.language?"ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑÿ£ŸàŸÑ":"First Name"}\n                  <span style="color: #ef4444;">*</span>\n                </label>\n                <input\n                  type="text"\n                  name="first-name"\n                  required\n                  style="\n                    width: 100%;\n                    padding: 8px 10px;\n                    border: 1px solid #d1d5db;\n                    border-radius: 6px;\n                    font-size: 13px;\n                    color: #374151;\n                    /* Prevent iOS zoom */\n                    font-size: 16px;\n                    transform-origin: left;\n                    transform: scale(0.8125);\n                  "\n                  placeholder="${"ar"===this.config.language?"ÿ£ÿ≠ŸÖÿØ":"Ahmad"}"\n                />\n              </div>\n\n              \x3c!-- Last Name --\x3e\n              <div style="margin-bottom: 12px;">\n                <label style="display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 4px;">\n                  ${"ar"===this.config.language?"ÿßÿ≥ŸÖ ÿßŸÑÿπÿßÿ¶ŸÑÿ©":"Last Name"}\n                  <span style="color: #ef4444;">*</span>\n                </label>\n                <input\n                  type="text"\n                  name="last-name"\n                  required\n                  style="\n                    width: 100%;\n                    padding: 8px 10px;\n                    border: 1px solid #d1d5db;\n                    border-radius: 6px;\n                    font-size: 13px;\n                    color: #374151;\n                    /* Prevent iOS zoom */\n                    font-size: 16px;\n                    transform-origin: left;\n                    transform: scale(0.8125);\n                  "\n                  placeholder="${"ar"===this.config.language?"ŸÖÿ≠ŸÖÿØ":"Mohamed"}"\n                />\n              </div>\n\n              \x3c!-- Email --\x3e\n              <div style="margin-bottom: 12px;">\n                <label style="display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 4px;">\n                  ${"ar"===this.config.language?"ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä":"Email"}\n                  <span style="color: #ef4444;">*</span>\n                </label>\n                <input\n                  type="email"\n                  name="your-email"\n                  required\n                  value="${i}"\n                  style="\n                    width: 100%;\n                    padding: 8px 10px;\n                    border: 1px solid #d1d5db;\n                    border-radius: 6px;\n                    font-size: 13px;\n                    color: #374151;\n                    /* Prevent iOS zoom */\n                    font-size: 16px;\n                    transform-origin: left;\n                    transform: scale(0.8125);\n                  "\n                  placeholder="your@email.com"\n                />\n              </div>\n\n              \x3c!-- Phone --\x3e\n              <div style="margin-bottom: 12px;">\n                <label style="display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 4px;">\n                  ${"ar"===this.config.language?"ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ":"Phone Number"}\n                  <span style="color: #ef4444;">*</span>\n                </label>\n                <input\n                  type="tel"\n                  name="phone"\n                  required\n                  pattern="05[0-9]{8}"\n                  maxlength="10"\n                  title="${"ar"===this.config.language?"Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ÿ±ŸÇŸÖ Ÿáÿßÿ™ŸÅ ÿµÿ≠Ÿäÿ≠ Ÿäÿ®ÿØÿ£ ÿ®ŸÄ 05":"Please enter a valid mobile number starts with 05"}"\n                  style="\n                    width: 100%;\n                    padding: 8px 10px;\n                    border: 1px solid #d1d5db;\n                    border-radius: 6px;\n                    font-size: 13px;\n                    color: #374151;\n                    /* Prevent iOS zoom */\n                    font-size: 16px;\n                    transform-origin: left;\n                    transform: scale(0.8125);\n                  "\n                  placeholder="${"ar"===this.config.language?"Ÿ†Ÿ•Ÿ†Ÿ°Ÿ¢Ÿ£Ÿ§Ÿ•Ÿ¶Ÿß":"0501234567"}"\n                />\n              </div>\n\n              \x3c!-- Organization --\x3e\n              <div style="margin-bottom: 12px;">\n                <label style="display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 4px;">\n                  ${"ar"===this.config.language?"ÿßÿ≥ŸÖ ÿßŸÑŸÖŸÜÿ∏ŸÖÿ©":"Organization Name"}\n                  <span style="color: #ef4444;">*</span>\n                </label>\n                <input\n                  type="text"\n                  name="organization"\n                  required\n                  style="\n                    width: 100%;\n                    padding: 8px 10px;\n                    border: 1px solid #d1d5db;\n                    border-radius: 6px;\n                    font-size: 13px;\n                    color: #374151;\n                    /* Prevent iOS zoom */\n                    font-size: 16px;\n                    transform-origin: left;\n                    transform: scale(0.8125);\n                  "\n                  placeholder="${"ar"===this.config.language?"ÿßÿ≥ŸÖ ÿ¥ÿ±ŸÉÿ™ŸÉ":"Your Company Name"}"\n                />\n              </div>\n\n              \x3c!-- Service Needed --\x3e\n              <div style="margin-bottom: 16px;">\n                <label style="display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 4px;">\n                  ${"ar"===this.config.language?"ÿßŸÑÿÆÿØŸÖÿ© ÿßŸÑŸÖÿ∑ŸÑŸàÿ®ÿ©":"Service Needed"}\n                </label>\n                <select\n                  name="service-needed"\n                  style="\n                    width: 100%;\n                    padding: 8px 10px;\n                    border: 1px solid #d1d5db;\n                    border-radius: 6px;\n                    font-size: 13px;\n                    color: #374151;\n                    background: white;\n                    /* Prevent iOS zoom */\n                    font-size: 16px;\n                    transform-origin: left;\n                    transform: scale(0.8125);\n                  "\n                >\n                  <option value="">${"ar"===this.config.language?"ÿßÿÆÿ™ÿ± ÿÆÿØŸÖÿ©":"Select a service"}</option>\n                  <option value="Training Consulting" ${o===("ar"===this.config.language?"ÿßÿ≥ÿ™ÿ¥ÿßÿ±ÿßÿ™ ÿßŸÑÿ™ÿØÿ±Ÿäÿ®":"Training Consulting")?"selected":""}>${"ar"===this.config.language?"ÿßÿ≥ÿ™ÿ¥ÿßÿ±ÿßÿ™ ÿßŸÑÿ™ÿØÿ±Ÿäÿ®":"Training Consulting"}</option>\n                  <option value="Leadership Development" ${o===("ar"===this.config.language?"ÿ™ÿ∑ŸàŸäÿ± ÿßŸÑŸÇŸäÿßÿØÿ©":"Leadership Development")?"selected":""}>${"ar"===this.config.language?"ÿ™ÿ∑ŸàŸäÿ± ÿßŸÑŸÇŸäÿßÿØÿ©":"Leadership Development"}</option>\n                  <option value="HR Development" ${o===("ar"===this.config.language?"ÿ™ÿ∑ŸàŸäÿ± ÿßŸÑŸÖŸàÿßÿ±ÿØ ÿßŸÑÿ®ÿ¥ÿ±Ÿäÿ©":"HR Development")?"selected":""}>${"ar"===this.config.language?"ÿ™ÿ∑ŸàŸäÿ± ÿßŸÑŸÖŸàÿßÿ±ÿØ ÿßŸÑÿ®ÿ¥ÿ±Ÿäÿ©":"HR Development"}</option>\n                  <option value="Professional Skills Development" ${o===("ar"===this.config.language?"ÿ™ÿ∑ŸàŸäÿ± ÿßŸÑŸÖŸáÿßÿ±ÿßÿ™ ÿßŸÑŸÖŸáŸÜŸäÿ©":"Professional Skills Development")?"selected":""}>${"ar"===this.config.language?"ÿ™ÿ∑ŸàŸäÿ± ÿßŸÑŸÖŸáÿßÿ±ÿßÿ™ ÿßŸÑŸÖŸáŸÜŸäÿ©":"Professional Skills Development"}</option>\n                  <option value="Fresh Graduates Development" ${o===("ar"===this.config.language?"ÿ™ÿ∑ŸàŸäÿ± ÿßŸÑÿÆÿ±Ÿäÿ¨ŸäŸÜ ÿßŸÑÿ¨ÿØÿØ":"Fresh Graduates Development")?"selected":""}>${"ar"===this.config.language?"ÿ™ÿ∑ŸàŸäÿ± ÿßŸÑÿÆÿ±Ÿäÿ¨ŸäŸÜ ÿßŸÑÿ¨ÿØÿØ":"Fresh Graduates Development"}</option>\n                  <option value="Coaching Services" ${o===("ar"===this.config.language?"ÿÆÿØŸÖÿßÿ™ ÿßŸÑÿ™ÿØÿ±Ÿäÿ®":"Coaching Services")?"selected":""}>${"ar"===this.config.language?"ÿÆÿØŸÖÿßÿ™ ÿßŸÑÿ™ÿØÿ±Ÿäÿ®":"Coaching Services"}</option>\n                  <option value="General">${"ar"===this.config.language?"ÿπÿßŸÖ":"General"}</option>\n                </select>\n              </div>\n\n              \x3c!-- Hidden fields --\x3e\n              <input type="hidden" name="page-url" value="${e.location.href}" />\n              <input type="hidden" name="page-title" value="${t.title}" />\n              <input type="hidden" name="language" value="${this.config.language}" />\n              <input type="hidden" name="custom-thank-you" value="yes" />\n\n              \x3c!-- Buttons --\x3e\n              <div style="\n                display: grid;\n                grid-template-columns: 1fr 1fr;\n                gap: 8px;\n              ">\n                <button\n                  type="button"\n                  onclick="this.closest('.b2b-request-form-message').remove()"\n                  style="\n                    padding: 10px;\n                    border: 1px solid #d1d5db;\n                    background: white;\n                    color: #6b7280;\n                    border-radius: 6px;\n                    font-size: 13px;\n                    font-weight: 500;\n                    cursor: pointer;\n                  "\n                >\n                  ${"ar"===this.config.language?"ÿ•ŸÑÿ∫ÿßÿ°":"Cancel"}\n                </button>\n                <button\n                  type="submit"\n                  style="\n                    padding: 10px;\n                    border: 1px solid #2563eb;\n                    background: #2563eb;\n                    color: white;\n                    border-radius: 6px;\n                    font-size: 13px;\n                    font-weight: 600;\n                    cursor: pointer;\n                    transition: background 0.2s;\n                  "\n                  onmouseover="this.style.background='#1d4ed8'"\n                  onmouseout="this.style.background='#2563eb'"\n                >\n                  üì® ${"ar"===this.config.language?"ÿ•ÿ±ÿ≥ÿßŸÑ":"Submit"}\n                </button>\n              </div>\n            </form>\n          </div>\n        </div>\n      `,r=t.createElement("div");r.innerHTML=s;const l=r.firstElementChild;this.elements.messages.appendChild(l),this.scrollToBottom();l.querySelector("#b2bRequestForm").addEventListener("submit",e=>{e.preventDefault(),this.submitB2BRequest(e.target,l)})}async submitB2BRequest(t,n){const a=new FormData(t),i=["first-name","last-name","your-email","phone","organization"];for(const e of i)if(!a.get(e))return this.addMessage("ar"===this.config.language?"‚ö†Ô∏è Ÿäÿ±ÿ¨Ÿâ ŸÖŸÑÿ° ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≠ŸÇŸàŸÑ ÿßŸÑŸÖÿ∑ŸÑŸàÿ®ÿ©":"‚ö†Ô∏è Please fill in all required fields","bot"),void this.scrollToBottom();const o=t.querySelector('button[type="submit"]'),s=o.innerHTML;o&&(o.disabled=!0,o.innerHTML="ar"===this.config.language?"‚è≥ ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ•ÿ±ÿ≥ÿßŸÑ...":"‚è≥ Submitting...");try{const t=new FormData;for(const[e,n]of a.entries())t.append(e,n);t.append("_wpcf7","9011"),t.append("_wpcf7_version","6.1.2"),t.append("_wpcf7_locale","ar"===this.config.language?"ar":"en_GB"),t.append("_wpcf7_unit_tag","wpcf7-f9011-chatbot"),t.append("_wpcf7_container_post","0"),t.append("_wpcf7_posted_data_hash",""),t.append("tharwah_service",a.get("service-needed")||"General"),t.append("cf7_form_id","9011"),t.append("current_page_url",e.location.href),t.append("utm_source",""),t.append("utm_medium",""),t.append("utm_campaign",""),t.append("gclid",""),t.append("fbclid",""),t.append("main-line",""),t.append("subline",""),this.log("Submitting B2B service request:",Object.fromEntries(t));const i=await fetch("https://academy.tharwah.net/wp-json/contact-form-7/v1/contact-forms/5229/feedback",{method:"POST",body:t});if(!i.ok)throw new Error(`HTTP error! status: ${i.status}`);const o=await i.json();if(this.log("B2B request response:",o),n&&n.remove(),"mail_sent"!==o.status)throw new Error(o.message||"Submission failed");{const e="ar"===this.config.language?"‚úÖ ÿ¥ŸÉÿ±ÿßŸã ŸÑŸÉ! ÿ™ŸÖ ÿ•ÿ±ÿ≥ÿßŸÑ ÿ∑ŸÑÿ®ŸÉ ÿ®ŸÜÿ¨ÿßÿ≠. ÿ≥ŸÜÿ™ŸàÿßÿµŸÑ ŸÖÿπŸÉ ŸÇÿ±Ÿäÿ®ÿßŸã.":"‚úÖ Thank you! Your request has been submitted successfully. We'll get back to you soon.";this.addMessage(e,"bot"),this.scrollToBottom()}this.trackEvent("b2b_service_request_submitted",{service:a.get("service-needed"),organization:a.get("organization"),email:a.get("your-email")})}catch(e){this.log("B2B service request error:",e);const t="ar"===this.config.language?"‚ùå ŸÅÿ¥ŸÑ ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ∑ŸÑÿ®. Ÿäÿ±ÿ¨Ÿâ ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ ÿ£Ÿà ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ŸÜÿß ŸÖÿ®ÿßÿ¥ÿ±ÿ©.":"‚ùå Failed to submit request. Please try again or contact us directly.";this.addMessage(t,"bot"),this.scrollToBottom(),o&&(o.disabled=!1,o.innerHTML=s),this.trackEvent("b2b_service_request_error",{error:e.message})}}}"undefined"!=typeof module&&module.exports&&(module.exports=n),e.TharwahChat=n,e.tharwahChatConfig&&(e.tharwahChatWidget=new n(e.tharwahChatConfig).init())}(window,document);