<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Exit Intent - Immediate Popover</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        
        h1 {
            color: #667eea;
            margin-bottom: 20px;
        }
        
        .info {
            background: #f0f4ff;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            border-left: 4px solid #667eea;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 16px 32px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .btn:hover {
            transform: scale(1.05);
        }
        
        .console {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 30px;
        }
        
        .console-line {
            margin: 4px 0;
            padding: 4px;
        }
        
        .console-line.warning {
            color: #ff9800;
        }
        
        .console-line.error {
            color: #f44336;
        }
        
        .console-line.success {
            color: #4caf50;
        }
        
        .status {
            background: #e8f5e9;
            border: 2px solid #4caf50;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .status.error {
            background: #ffebee;
            border-color: #f44336;
        }
        
        code {
            background: #f0f4ff;
            padding: 2px 6px;
            border-radius: 4px;
            color: #667eea;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Exit Intent Test</h1>
        
        <div class="info">
            <h3>üìã Test Instructions:</h3>
            <ol style="margin-left: 20px; margin-top: 10px;">
                <li><strong>Configure:</strong> Update the tracker configuration below with your API key and endpoint</li>
                <li><strong>Load Page:</strong> Open browser console (F12) to see detailed logs</li>
                <li><strong>Test Exit Intent:</strong>
                    <ul style="margin-left: 20px; margin-top: 5px;">
                        <li>Move your mouse cursor to the very top of the browser (like you're going to close the tab)</li>
                        <li>OR click the "Simulate Exit Intent" button below</li>
                    </ul>
                </li>
                <li><strong>Check Console:</strong> You should see logs indicating:
                    <ul style="margin-left: 20px; margin-top: 5px;">
                        <li>‚úÖ Event tracked: exit_intent</li>
                        <li>‚úÖ Event triggers immediate popover check: exit_intent</li>
                        <li>‚ö° Requesting popover for event: exit_intent</li>
                        <li>üîç checkForPopover() called</li>
                        <li>üì° Requesting popover from: [API URL]</li>
                    </ul>
                </li>
            </ol>
        </div>
        
        <div id="status" class="status">
            <strong>Status:</strong> Waiting for tracker initialization...
        </div>
        
        <button class="btn" onclick="simulateExitIntent()">üö™ Simulate Exit Intent</button>
        
        <div class="console" id="console">
            <div class="console-line">Console output will appear here...</div>
        </div>
    </div>
    
    <!-- Load Tracker -->
    <script src="../dist/TharwahTracker-V2.js"></script>
    
    <!-- Load Chat Widget (optional) -->
    <script>
        window.tharwahChatConfig = {
            title: 'Need Help?',
            welcomeMessage: 'üëã Hi! How can I help you?',
            apiEndpoint: 'http://localhost:8000/api',
            botId: 1,
            organizationId: 2,
            apiKey: 'org_d2e06bbb.1hzazsqKSgpPsGB_W1q_SZwRA2rnqtE9L49HU-J2fHg',
        };
    </script>
    <script src="../dist/TharwahChat-V1.js"></script>
    
    <!-- Initialize and Test -->
    <script>
        // Custom console to display in page
        const consoleDiv = document.getElementById('console');
        const statusDiv = document.getElementById('status');
        
        function addLog(message, type = 'info') {
            const line = document.createElement('div');
            line.className = `console-line ${type}`;
            line.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            consoleDiv.insertBefore(line, consoleDiv.firstChild);
            
            // Keep only last 50 lines
            while (consoleDiv.children.length > 50) {
                consoleDiv.removeChild(consoleDiv.lastChild);
            }
        }
        
        function updateStatus(message, isError = false) {
            statusDiv.className = `status ${isError ? 'error' : ''}`;
            statusDiv.innerHTML = `<strong>Status:</strong> ${message}`;
        }
        
        // Override console.log to capture tracker logs
        const originalLog = console.log;
        console.log = function(...args) {
            originalLog.apply(console, args);
            
            // Check if this is a tracker log
            if (args[0] === '[UniversalTracker]') {
                const message = args.slice(1).map(a => 
                    typeof a === 'object' ? JSON.stringify(a, null, 2) : String(a)
                ).join(' ');
                
                let type = 'info';
                if (message.includes('‚ùå') || message.includes('Error')) {
                    type = 'error';
                } else if (message.includes('‚ö†Ô∏è')) {
                    type = 'warning';
                } else if (message.includes('‚úÖ') || message.includes('‚ö°')) {
                    type = 'success';
                }
                
                addLog(message, type);
            }
        };
        
        // Initialize tracker with DEBUGGING ENABLED
        addLog('Initializing tracker...', 'info');
        
        try {
            window.tracker = new UniversalTracker({
                projectId: 'exit-intent-test',
                apiEndpoint: 'http://localhost:8000/api/track/',
                debug: true, // IMPORTANT: Enable debug mode
                
                // Tracking
                trackPageViews: true,
                trackClicks: true,
                
                // Popover configuration
                enablePopovers: true,
                popoverApiKey: 'org_d2e06bbb.1hzazsqKSgpPsGB_W1q_SZwRA2rnqtE9L49HU-J2fHg', // ‚ö†Ô∏è REPLACE WITH YOUR API KEY
                popoverUseFastEndpoint: false, // Use fast rule-based endpoint
                popoverMaxPerSession: 5,
                popoverMinDelay: 5000, // Wait 5s before first check
                apiKey: 'org_d2e06bbb.1hzazsqKSgpPsGB_W1q_SZwRA2rnqtE9L49HU-J2fHg',
                
                // Immediate triggers
                immediatePopoverEvents: [
                    'exit_intent',
                    'rage_click',
                    'form_abandon',
                    'form_start',
                    'scroll_depth'
                ]
            }).init();
            
            addLog('‚úÖ Tracker initialized successfully', 'success');
            addLog(`Session ID: ${tracker.sessionId}`, 'info');
            addLog(`Popovers enabled: ${tracker.config.enablePopovers}`, 'info');
            addLog(`API Key configured: ${!!tracker.config.popoverApiKey}`, 'info');
            addLog(`Immediate events: ${tracker.config.immediatePopoverEvents.join(', ')}`, 'info');
            
            updateStatus('‚úÖ Tracker initialized and ready. Move mouse to top or click button to test.');
            
        } catch (error) {
            addLog(`‚ùå Error initializing tracker: ${error.message}`, 'error');
            updateStatus(`‚ùå Error: ${error.message}`, true);
        }
        
        // Simulate exit intent
        function simulateExitIntent() {
            addLog('üö™ Simulating exit intent...', 'warning');
            updateStatus('üö™ Simulating exit intent... check console for details.');
            
            const event = new MouseEvent('mouseout', {
                bubbles: true,
                cancelable: true,
                clientY: -10 // Negative Y = moving to top
            });
            
            document.dispatchEvent(event);
            
            // Give it a moment to process
            setTimeout(() => {
                addLog('Exit intent simulation complete. Check logs above.', 'info');
            }, 500);
        }
        
        // Listen to tracker events
        window.addEventListener('tracker:track', (e) => {
            const event = e.detail;
            addLog(`üìä Event tracked: ${event.event}`, 'success');
            
            if (event.event === 'exit_intent') {
                updateStatus('‚úÖ Exit intent tracked! Checking for popover...');
            }
        });
        
        window.addEventListener('tracker:flush', (e) => {
            if (e.detail.success) {
                addLog(`üì§ Sent ${e.detail.count} events to backend`, 'success');
            } else {
                addLog(`‚ùå Failed to send events: ${e.detail.error}`, 'error');
            }
        });
    </script>
</body>
</html>
